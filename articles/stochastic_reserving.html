<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example Stochastic Reserving â€¢ stochasticreserver</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example Stochastic Reserving">
<style>
.code-fold-btn {
  cursor: pointer;
  padding: 0.25em 0.5em;
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 0.25rem;
  margin-bottom: 0.5em;
  font-size: 0.85em;
  display: inline-block;
}
.code-fold-btn:hover {
  background-color: #e9ecef;
}
.sourceCode.hidden {
  display: none;
}
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">stochasticreserver</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/comprehensive_tutorial.html">Comprehensive Tutorial</a></li>
    <li><a class="dropdown-item" href="../articles/stochastic_reserving.html">Example Stochastic Reserving</a></li>
    <li><a class="dropdown-item" href="../articles/manual.html">Manual</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Example Stochastic Reserving</h1>
                        <h4 data-toc-skip class="author">Roger
Hayne</h4>
            
            <h4 data-toc-skip class="date">9/6/2019</h4>
      

      <div class="d-none name"><code>stochastic_reserving.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">mvtnorm</a></span><span class="op">)</span></span>
<span><span class="co">#library(MASS)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">abind</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stochasticreserver</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="initialize-triangle">Initialize Triangle<a class="anchor" aria-label="anchor" href="#initialize-triangle"></a>
</h3>
<p>Input (B0) is a development array of cumulative averages with a the
exposures (claims) used in the denominator appended as the last column.
Assumption is for the same development increments as exposure increments
and that all development lags with no development have # been removed.
Data elements that are not available are indicated as such. This should
work (but not tested for) just about any subset of an upper triangular
data matrix.<br>
Another requirement of this code is that the matrix contain no columns
that are all zero.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">B0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">670.25868</span>,<span class="fl">1480.24821</span>,<span class="fl">1938.53579</span>,<span class="fl">2466.25469</span>,<span class="fl">2837.84888</span>,<span class="fl">3003.52391</span>,</span>
<span>            <span class="fl">3055.38674</span>,<span class="fl">3132.93838</span>,<span class="fl">3141.18638</span>,<span class="fl">3159.72524</span>,</span>
<span>            <span class="fl">767.98833</span>,<span class="fl">1592.50266</span>,<span class="fl">2463.79447</span>,<span class="fl">3019.71976</span>,<span class="fl">3374.72689</span>,<span class="fl">3553.61387</span>,<span class="fl">3602.27898</span>,</span>
<span>            <span class="fl">3627.28386</span>,<span class="fl">3645.5656</span>,<span class="cn">NA</span>,</span>
<span>            <span class="fl">740.57952</span>,<span class="fl">1615.79681</span>,<span class="fl">2345.85028</span>,<span class="fl">2910.52511</span>,<span class="fl">3201.5226</span>,<span class="fl">3417.71335</span>,<span class="fl">3506.58672</span>,</span>
<span>            <span class="fl">3529.00243</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>            <span class="fl">862.11956</span>,<span class="fl">1754.90405</span>,<span class="fl">2534.77727</span>,<span class="fl">3270.85361</span>,<span class="fl">3739.88962</span>,<span class="fl">4003.00219</span>,<span class="fl">4125.30694</span>,</span>
<span>            <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>            <span class="fl">840.94172</span>,<span class="fl">1859.02531</span>,<span class="fl">2804.54535</span>,<span class="fl">3445.34665</span>,<span class="fl">3950.47098</span>,<span class="fl">4185.95298</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>            <span class="fl">848.00496</span>,<span class="fl">2052.922</span>,<span class="fl">3076.13789</span>,<span class="fl">3861.03111</span>,<span class="fl">4351.57694</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>            <span class="fl">901.77403</span>,<span class="fl">1927.88718</span>,<span class="fl">3003.58919</span>,<span class="fl">3881.41744</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>            <span class="fl">935.19866</span>,<span class="fl">2103.97736</span>,<span class="fl">3181.75054</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>            <span class="fl">759.32467</span>,<span class="fl">1584.91057</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>            <span class="fl">723.30282</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>,<span class="fl">10</span>,<span class="fl">10</span>,byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># the exposures (claims) used in the denominator</span></span>
<span><span class="va">dnom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">39161.</span>,<span class="fl">38672.4628</span>,<span class="fl">41801.048</span>,<span class="fl">42263.2794</span>,<span class="fl">41480.8768</span>,<span class="fl">40214.3872</span>,<span class="fl">43598.5056</span>,</span>
<span>       <span class="fl">42118.324</span>,<span class="fl">43479.4248</span>,<span class="fl">49492.4106</span><span class="op">)</span></span>
<span></span>
<span><span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">B0</span><span class="op">)</span></span>
<span><span class="co"># Identify model to be used</span></span>
<span><span class="co">#   Berquist for the Berquist-Sherman Incremental Severity</span></span>
<span><span class="co">#   CapeCod for the Cape Cod</span></span>
<span><span class="co">#   Hoerl for the Generalized Hoerl Curve Model with trend</span></span>
<span><span class="co">#   Wright for the Generalized Hoerl Curve with individual accident year levels</span></span>
<span><span class="co">#   Chain for the Chain Ladder model</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"Berquist"</span></span>
<span><span class="co">#model &lt;- "CapeCod"</span></span>
<span><span class="co">#model &lt;- "Hoerl"</span></span>
<span><span class="co">#model &lt;- "Wright"</span></span>
<span><span class="co">#model &lt;- "Chain"</span></span>
<span><span class="co"># Toggle graphs off if desired</span></span>
<span><span class="va">graphs</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="co"># Toggle simulations off if desired</span></span>
<span><span class="va">simulation</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate incremental average matrix</span></span>
<span><span class="va">A0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">B0</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="op">(</span><span class="va">B0</span><span class="op">[</span>, <span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="va">size</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0</span> <span class="op">*</span> <span class="va">B0</span><span class="op">[</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span></span>
<span>             <span class="op">(</span><span class="va">B0</span><span class="op">[</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0</span> <span class="op">*</span> <span class="va">B0</span><span class="op">[</span>, <span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="va">size</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Generate a matrix to reflect exposure count in the variance structure</span></span>
<span><span class="va">logd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">dnom</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set up matrix of rows and columns, makes later calculations simpler</span></span>
<span><span class="va">rowNum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.html" class="external-link">row</a></span><span class="op">(</span><span class="va">A0</span><span class="op">)</span></span>
<span><span class="va">colNum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/col.html" class="external-link">col</a></span><span class="op">(</span><span class="va">A0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#. upper_triangle_mask is a mask matrix of allowable data, upper triangular assuming same</span></span>
<span><span class="co">#' development increments as exposure increments</span></span>
<span><span class="co">#' msn is a mask matrix that picks off the first forecast diagonal</span></span>
<span><span class="co">#' msd is a mask matrix that picks off the to date diagonal</span></span>
<span><span class="va">upper_triangle_mask</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="va">rowNum</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">msn</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="va">rowNum</span><span class="op">)</span> <span class="op">==</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">2</span></span>
<span><span class="va">msd</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="va">rowNum</span><span class="op">)</span> <span class="op">==</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Amount paid to date</span></span>
<span><span class="va">paid_to_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">B0</span> <span class="op">*</span> <span class="va">msd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="start-of-model-specific-code">START OF MODEL SPECIFIC CODE<a class="anchor" aria-label="anchor" href="#start-of-model-specific-code"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw">if</span> <span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="st">"Berquist"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model_lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/berquist.html">berquist</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="st">"CapeCod"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model_lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/capecod.html">capecod</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="st">"Hoerl"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model_lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoerl.html">hoerl</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="st">"Wright"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model_lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wright.html">wright</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="st">"Chain"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model_lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chain.html">chain</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">g_obj</span> <span class="op">&lt;-</span> <span class="va">model_lst</span><span class="op">$</span><span class="va">g_obj</span></span>
<span><span class="va">g_grad</span> <span class="op">&lt;-</span> <span class="va">model_lst</span><span class="op">$</span><span class="va">g_grad</span></span>
<span><span class="va">g_hess</span> <span class="op">&lt;-</span> <span class="va">model_lst</span><span class="op">$</span><span class="va">g_hess</span></span>
<span><span class="va">a0</span> <span class="op">&lt;-</span> <span class="va">model_lst</span><span class="op">$</span><span class="va">a0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="negative-loglikelihood-function-to-be-minimized">Negative Loglikelihood Function to be Minimized<a class="anchor" aria-label="anchor" href="#negative-loglikelihood-function-to-be-minimized"></a>
</h3>
<p>Note that the general form of the model has parameters in addition to
those in the loss model, namely the power for the variance and the
constant of proprtionality that varies by column. So if the original
model has k parameters with size columns of data, the total objective
function has k + size + 1 parameters</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l.obj</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">npar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span></span>
<span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu">g_obj</span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">logd</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">size</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">e</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="va">a</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="va">v</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>  <span class="va">t2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">A</span> <span class="op">-</span> <span class="va">e</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">v</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Gradient of the objective function</span></span>
<span><span class="va">l.grad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">npar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">Av</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">A</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu">g_obj</span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">ev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">e</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">logd</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">size</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">e</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="va">p</span></span>
<span>  <span class="va">vv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">v</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu">g_grad</span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="va">p</span> <span class="op">/</span> <span class="va">ev</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">ev</span> <span class="op">-</span> <span class="va">Av</span><span class="op">)</span> <span class="op">/</span> <span class="va">vv</span> <span class="op">-</span> <span class="va">p</span> <span class="op">*</span> </span>
<span>                                      <span class="op">(</span><span class="va">Av</span> <span class="op">-</span> <span class="va">ev</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="va">vv</span> <span class="op">*</span> <span class="va">ev</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               na.rm <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>               dims <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">yy</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="va">A</span> <span class="op">-</span> <span class="va">e</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="va">v</span></span>
<span>  <span class="va">dk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">yy</span> <span class="op">/</span> <span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">dp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">yy</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">e</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">dk</span>, <span class="va">dp</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="hessian-of-the-objective-function">Hessian of the objective function<a class="anchor" aria-label="anchor" href="#hessian-of-the-objective-function"></a>
</h3>
<ul>
<li>e is the expectated value matrix</li>
<li>v is the matrix of variances</li>
<li>A, e, v all have shape c(size, size)</li>
<li>The variables _v are copies of the originals to shape
c(npar,size,size), paralleling the gradient of g.</li>
<li>The variables _m are copies of the originals to shape
c(npar,npar,size,size), paralleling the hessian of g</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l.hess</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">npar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">Av</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">A</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Am</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">A</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu">g_obj</span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">ev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">e</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">em</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">e</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">logd</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">size</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">e</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">^</span> <span class="va">p</span></span>
<span>  <span class="va">vv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">v</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">vm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">v</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu">g_grad</span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">g1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">npar</span>, <span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">gg</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="va">gg</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">gh</span> <span class="op">&lt;-</span> <span class="fu">g_hess</span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">dtt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span></span>
<span>    <span class="va">gh</span> <span class="op">*</span> <span class="op">(</span><span class="va">p</span> <span class="op">/</span> <span class="va">em</span> <span class="op">+</span> <span class="op">(</span><span class="va">em</span> <span class="op">-</span> <span class="va">Am</span><span class="op">)</span> <span class="op">/</span> <span class="va">vm</span> <span class="op">-</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="va">Am</span> <span class="op">-</span> <span class="va">em</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="va">vm</span> <span class="op">*</span> <span class="va">em</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="va">gg</span> <span class="op">*</span> <span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">/</span> <span class="va">vm</span> <span class="op">+</span> <span class="fl">4</span> <span class="op">*</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="va">Am</span> <span class="op">-</span> <span class="va">em</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">vm</span> <span class="op">*</span> <span class="va">em</span><span class="op">)</span> <span class="op">+</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">p</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">Am</span> <span class="op">-</span> <span class="va">em</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span></span>
<span>          <span class="op">(</span><span class="va">vm</span> <span class="op">*</span> <span class="va">em</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="va">p</span> <span class="op">/</span> <span class="va">em</span> <span class="op">^</span> <span class="fl">2</span></span>
<span>      <span class="op">)</span>,</span>
<span>    dims <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">dkt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="op">(</span><span class="va">g1</span> <span class="op">*</span> <span class="op">(</span><span class="va">Av</span> <span class="op">-</span> <span class="va">ev</span><span class="op">)</span> <span class="op">+</span> <span class="va">p</span> <span class="op">*</span> <span class="va">g1</span> <span class="op">*</span> <span class="op">(</span><span class="va">Av</span> <span class="op">-</span> <span class="va">ev</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="va">ev</span><span class="op">)</span> <span class="op">/</span> <span class="va">vv</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">dtp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">g1</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">ev</span> <span class="op">+</span> <span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ev</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">Av</span> <span class="op">-</span> <span class="va">ev</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">p</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ev</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">Av</span> <span class="op">-</span> <span class="va">ev</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="va">ev</span></span>
<span>  <span class="op">)</span> <span class="op">/</span> <span class="va">vv</span><span class="op">)</span>,</span>
<span>  na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">dkk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">A</span> <span class="op">-</span> <span class="va">e</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">v</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">dpk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">e</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">A</span> <span class="op">-</span> <span class="va">e</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">v</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">dpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">e</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">A</span> <span class="op">-</span> <span class="va">e</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">v</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">dkt</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dtp</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dtt</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">m1</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dkk</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">dpk</span></span>
<span>  <span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dpk</span>, <span class="va">dpp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>End of funciton specificaitons now on to the minimization</p>
</div>
<div class="section level3">
<h3 id="minimization">Minimization<a class="anchor" aria-label="anchor" href="#minimization"></a>
</h3>
<div class="section level4">
<h4 id="get-starting-values-for-kappa-and-p-parameters-default-10-and-1">Get starting values for kappa and p parameters, default 10 and
1<a class="anchor" aria-label="anchor" href="#get-starting-values-for-kappa-and-p-parameters-default-10-and-1"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ttt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>For starting values use fitted objective function and assume variance
for a cell is estimated by the square of the difference between actual
and expected averages. Note since log(0) is -Inf we need to go through
some machinations to prep the y values for the fit</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">E</span> <span class="op">&lt;-</span> <span class="fu">g_obj</span><span class="op">(</span><span class="va">a0</span><span class="op">)</span></span>
<span><span class="va">yyy</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">A0</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">yyy</span> <span class="op">&lt;-</span> <span class="va">logd</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="va">yyy</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="va">yyy</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">yyy</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">E</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yyy</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ttt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">sss</span><span class="op">$</span><span class="va">y</span> <span class="op">~</span> <span class="va">sss</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">a0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">a0</span>, <span class="va">ttt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="co"># to check reproducibility with original code</span></span>
<span><span class="va">max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>iter.max <span class="op">=</span> <span class="fl">10000</span>, eval.max <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="actual-minimization">Actual minimization<a class="anchor" aria-label="anchor" href="#actual-minimization"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">a0</span>, <span class="va">l.obj</span>, gradient <span class="op">=</span> <span class="va">l.grad</span>, hessian <span class="op">=</span> <span class="va">l.hess</span>, </span>
<span>             scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="va">a0</span> <span class="op">*</span> <span class="op">(</span><span class="va">a0</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="va">a0</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             A <span class="op">=</span> <span class="va">A0</span>, control <span class="op">=</span> <span class="va">max</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="model-statistics">Model statistics<a class="anchor" aria-label="anchor" href="#model-statistics"></a>
</h4>
<ul>
<li>
<strong>mean</strong> and <strong>var</strong> are model fitted
values</li>
<li>
<strong>stres</strong> is the standardized residuals</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">npar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">a0</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">mean</span> <span class="op">&lt;-</span> <span class="fu">g_obj</span><span class="op">(</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">logd</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">size</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">mean</span> <span class="op">^</span></span>
<span>                                                                   <span class="fl">2</span><span class="op">)</span> <span class="op">^</span> <span class="va">p</span></span>
<span><span class="va">stres</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">A0</span> <span class="op">-</span> <span class="va">mean</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu">g_grad</span><span class="op">(</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">g1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">npar</span>, <span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">gg</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="va">gg</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">meanv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">mean</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">meanm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">mean</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">varm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">var</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="masks-to-screen-out-na-entries-in-original-input-matrix">Masks to screen out NA entries in original input matrix<a class="anchor" aria-label="anchor" href="#masks-to-screen-out-na-entries-in-original-input-matrix"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="op">*</span> <span class="va">A0</span></span>
<span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">s</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">s</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">npar</span>, <span class="va">npar</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="calculate-the-information-matrix">Calculate the information matrix<a class="anchor" aria-label="anchor" href="#calculate-the-information-matrix"></a>
</h4>
<ul>
<li>Using second derivatives of the log likelihood function Second with
respect to theta parameters</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">sm</span> <span class="op">+</span> <span class="va">gg</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">varm</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">p</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="va">meanm</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, dims <span class="op">=</span> <span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Second with respect to theta and kappa</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kt</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">sv</span> <span class="op">+</span> <span class="va">g1</span> <span class="op">/</span> <span class="va">meanv</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Second with respect to p and theta</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tp</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">sv</span> <span class="op">+</span> <span class="va">g1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">meanv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">meanv</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Second with respect to kappa</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kk</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">s</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Second with respect to p and kappa</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">mean</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Second with respect to p</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">mean</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-information-matrix-in-blocks">Create information matrix in blocks<a class="anchor" aria-label="anchor" href="#create-information-matrix-in-blocks"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">kt</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">inf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">tt</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">m1</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">kk</span>, <span class="va">pk</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pk</span>, <span class="va">pp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="variance-covariance-matrix-for-parameters-inverse-of-information-matrix">Variance-covariance matrix for parameters, inverse of information
matrix<a class="anchor" aria-label="anchor" href="#variance-covariance-matrix-for-parameters-inverse-of-information-matrix"></a>
</h2>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vcov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">inf</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h4>
<p>Initialize simulation array to keep simulation results</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">11</span><span class="op">)</span></span>
<span><span class="va">smn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">11</span><span class="op">)</span></span>
<span><span class="va">spm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Simulation for distribution of future amounts</p>
<p>Want 10,000 simulations, but exceeds R capacity, so do in batches of
5,000</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nsim</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span><span class="va">smsk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">upper_triangle_mask</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">nsim</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">smsn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">msn</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">nsim</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">simulation</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Randomly generate parameters from multivariate normal</span></span>
<span>    <span class="va">spar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="va">mle</span><span class="op">$</span><span class="va">par</span>, <span class="va">vcov</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Arrays to calculate simulated means</span></span>
<span>    <span class="va">esim</span> <span class="op">&lt;-</span> <span class="fu">g_obj</span><span class="op">(</span><span class="va">spar</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Arrays to calculate simulated variances</span></span>
<span>    <span class="va">ksim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>      <span class="va">spar</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="va">size</span><span class="op">)</span></span>
<span>    <span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">dnom</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">psim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">spar</span><span class="op">[</span>, <span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">vsim</span> <span class="op">&lt;-</span> <span class="va">ksim</span> <span class="op">*</span> <span class="op">(</span><span class="va">esim</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">^</span> <span class="va">psim</span></span>
<span></span>
<span>    <span class="co"># Randomly simulate future averages</span></span>
<span>    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nsim</span> <span class="op">*</span> <span class="va">size</span> <span class="op">*</span> <span class="va">size</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">esim</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vsim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Combine to total by exposure period and in aggregate</span></span>
<span>    <span class="co"># notice separate array with name ending in "n" to capture</span></span>
<span>    <span class="co"># forecast for next accounting period</span></span>
<span>    <span class="va">sdnm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">dnom</span>, <span class="va">size</span>, <span class="va">nsim</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">fore</span> <span class="op">&lt;-</span> <span class="va">sdnm</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">*</span> <span class="op">!</span><span class="va">smsk</span>, dims <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">forn</span> <span class="op">&lt;-</span> <span class="va">sdnm</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">*</span> <span class="va">smsn</span>, dims <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Cumulate and return for another 5,000</span></span>
<span>    <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">fore</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">fore</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">smn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">smn</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">forn</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">forn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">spm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">spm</span>, <span class="va">spar</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="print-results">Print Results<a class="anchor" aria-label="anchor" href="#print-results"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Berquist"</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/model_description.html">model_description</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Berquist-Sherman Incremental Severity"</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        V1          V2                 V3                 V4          </span></span>
<span><span class="co">##  Min.   :0   Min.   :-1452523   Min.   :-1460032   Min.   :-1416929  </span></span>
<span><span class="co">##  1st Qu.:0   1st Qu.:  302558   1st Qu.:  811550   1st Qu.: 2807320  </span></span>
<span><span class="co">##  Median :0   Median :  597817   Median : 1228080   Median : 3544006  </span></span>
<span><span class="co">##  Mean   :0   Mean   :  642440   Mean   : 1252318   Mean   : 3558347  </span></span>
<span><span class="co">##  3rd Qu.:0   3rd Qu.:  932306   3rd Qu.: 1673686   3rd Qu.: 4290686  </span></span>
<span><span class="co">##  Max.   :0   Max.   : 3508046   Max.   : 4460242   Max.   : 8808302  </span></span>
<span><span class="co">##        V5                 V6                 V7                 V8           </span></span>
<span><span class="co">##  Min.   :   -6553   Min.   : 5560629   Min.   :20506185   Min.   : 42237266  </span></span>
<span><span class="co">##  1st Qu.: 6227569   1st Qu.:15141382   1st Qu.:37021474   1st Qu.: 69227330  </span></span>
<span><span class="co">##  Median : 7336299   Median :17015966   Median :40212065   Median : 74008098  </span></span>
<span><span class="co">##  Mean   : 7343317   Mean   :17027739   Mean   :40274082   Mean   : 74154814  </span></span>
<span><span class="co">##  3rd Qu.: 8459679   3rd Qu.:18881648   3rd Qu.:43484551   3rd Qu.: 78916652  </span></span>
<span><span class="co">##  Max.   :15788019   Max.   :29283048   Max.   :63449354   Max.   :110991079  </span></span>
<span><span class="co">##        V9                 V10                 V11           </span></span>
<span><span class="co">##  Min.   : 84207233   Min.   :155320285   Min.   :366516154  </span></span>
<span><span class="co">##  1st Qu.:119093974   1st Qu.:198804197   1st Qu.:460324346  </span></span>
<span><span class="co">##  Median :126196817   Median :209482103   Median :479599631  </span></span>
<span><span class="co">##  Mean   :126342190   Mean   :209675354   Mean   :480270601  </span></span>
<span><span class="co">##  3rd Qu.:133428500   3rd Qu.:220366856   3rd Qu.:499535658  </span></span>
<span><span class="co">##  Max.   :173619116   Max.   :279848807   Max.   :598174718</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">smn</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        V1          V2                 V3                 V4          </span></span>
<span><span class="co">##  Min.   :0   Min.   :-1452523   Min.   :-1138446   Min.   :-1476281  </span></span>
<span><span class="co">##  1st Qu.:0   1st Qu.:  302558   1st Qu.:  272247   1st Qu.: 1626501  </span></span>
<span><span class="co">##  Median :0   Median :  597817   Median :  505270   Median : 2200960  </span></span>
<span><span class="co">##  Mean   :0   Mean   :  642440   Mean   :  527492   Mean   : 2230028  </span></span>
<span><span class="co">##  3rd Qu.:0   3rd Qu.:  932306   3rd Qu.:  758791   3rd Qu.: 2800206  </span></span>
<span><span class="co">##  Max.   :0   Max.   : 3508046   Max.   : 2627158   Max.   : 6670925  </span></span>
<span><span class="co">##        V5                 V6                 V7                 V8          </span></span>
<span><span class="co">##  Min.   :-1172470   Min.   : 1270164   Min.   : 5239797   Min.   :11507452  </span></span>
<span><span class="co">##  1st Qu.: 2880155   1st Qu.: 8086341   1st Qu.:18510808   1st Qu.:30127968  </span></span>
<span><span class="co">##  Median : 3663228   Median : 9515524   Median :20882468   Median :33338663  </span></span>
<span><span class="co">##  Mean   : 3691096   Mean   : 9561369   Mean   :20957144   Mean   :33428879  </span></span>
<span><span class="co">##  3rd Qu.: 4467433   3rd Qu.:11003597   3rd Qu.:23334596   3rd Qu.:36694937  </span></span>
<span><span class="co">##  Max.   : 9452336   Max.   :19788052   Max.   :38041131   Max.   :56230971  </span></span>
<span><span class="co">##        V9                V10                 V11           </span></span>
<span><span class="co">##  Min.   :23972497   Min.   : 23306626   Min.   :118324354  </span></span>
<span><span class="co">##  1st Qu.:42126743   1st Qu.: 54269334   1st Qu.:167789490  </span></span>
<span><span class="co">##  Median :46211701   Median : 59039646   Median :176256113  </span></span>
<span><span class="co">##  Mean   :46263910   Mean   : 59065905   Mean   :176368264  </span></span>
<span><span class="co">##  3rd Qu.:50318506   3rd Qu.: 63803067   3rd Qu.:184790407  </span></span>
<span><span class="co">##  Max.   :74988812   Max.   :103912858   Max.   :231225457</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="scatter-plots-of-residuals-distribution-of-forecasts">Scatter plots of residuals &amp; Distribution of Forecasts<a class="anchor" aria-label="anchor" href="#scatter-plots-of-residuals-distribution-of-forecasts"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="va">graphs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#x11(title &lt;- model_description(model))</span></span>
<span></span>
<span>  <span class="co"># Prep data for lines for averages in scatter plots of standardized residuals</span></span>
<span>  <span class="va">ttt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rowNum</span> <span class="op">+</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">19</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">19</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Plotting</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rowNum</span> <span class="op">+</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    main <span class="op">=</span> <span class="st">"Standardized Residuals by CY"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"CY"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Standardized Residual"</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">18</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">ttt</span><span class="op">[</span>, <span class="fl">2</span>, <span class="op">]</span> <span class="op">*</span></span>
<span>                  <span class="op">(</span><span class="va">ttt</span><span class="op">[</span>, <span class="fl">1</span>, <span class="op">]</span> <span class="op">==</span> <span class="va">sss</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="op">(</span><span class="va">ttt</span><span class="op">[</span>, <span class="fl">1</span>, <span class="op">]</span> <span class="op">==</span> <span class="va">sss</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fl">0</span> <span class="op">*</span></span>
<span>                <span class="va">ttt</span><span class="op">[</span>, <span class="fl">2</span>, <span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">colNum</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    main <span class="op">=</span> <span class="st">"Standardized Residuals by Lag"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Lag"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Standardized Residual"</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">18</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">colNum</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">stres</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">0</span> <span class="op">*</span> <span class="va">stres</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqline</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">simulation</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">proc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="fl">11</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>,</span>
<span>                y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="fl">11</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>,</span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                            <span class="va">dnom</span></span>
<span>                          <span class="op">)</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span> <span class="op">*</span> <span class="va">mean</span> <span class="op">*</span> <span class="op">!</span><span class="va">upper_triangle_mask</span><span class="op">)</span>,</span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span></span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dnom</span><span class="op">)</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">var</span> <span class="op">*</span> <span class="op">!</span><span class="va">upper_triangle_mask</span></span>
<span>                          <span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html" class="external-link">truehist</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="fl">11</span><span class="op">]</span>,</span>
<span>             ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">proc</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>             main <span class="op">=</span> <span class="st">"All Years Combined Future Amounts"</span>,</span>
<span>             xlab <span class="op">=</span> <span class="st">"Aggregate"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">proc</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="stochastic_reserving_files/figure-html/plots-1.png" class="r-plt" alt="" width="700">
## Summary From Simulation</p>
<p>Summary of mean, standard deviation, and 90% confidence interval from
simulation, similar for one-period forecast</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sumr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">sumn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sumr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sumr</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>, <span class="fl">.95</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sumn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sumn</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">smn</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">smn</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">smn</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>, <span class="fl">.95</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sumr</span></span></code></pre></div>
<pre><code><span><span class="co">##                                        5%       95%</span></span>
<span><span class="co">##  [1,]         0.0        0.0         0.00         0</span></span>
<span><span class="co">##  [2,]    642440.5   481028.8    -44194.36   1501201</span></span>
<span><span class="co">##  [3,]   1252318.1   648086.8    234536.28   2350542</span></span>
<span><span class="co">##  [4,]   3558346.6  1140237.1   1736139.47   5459264</span></span>
<span><span class="co">##  [5,]   7343316.8  1685230.7   4618772.27  10135134</span></span>
<span><span class="co">##  [6,]  17027739.1  2812746.4  12455686.23  21698143</span></span>
<span><span class="co">##  [7,]  40274081.9  4840499.9  32377990.92  48358166</span></span>
<span><span class="co">##  [8,]  74154813.9  7300843.4  62309918.99  86306505</span></span>
<span><span class="co">##  [9,] 126342190.5 10639635.7 109032027.02 144116409</span></span>
<span><span class="co">## [10,] 209675353.5 15905776.4 183850667.27 236026995</span></span>
<span><span class="co">## [11,] 480270600.9 29296749.7 432905077.05 529557186</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sumn</span></span></code></pre></div>
<pre><code><span><span class="co">##                                        5%       95%</span></span>
<span><span class="co">##  [1,]         0.0        0.0         0.00         0</span></span>
<span><span class="co">##  [2,]    642440.5   481028.8    -44194.36   1501201</span></span>
<span><span class="co">##  [3,]    527492.0   376363.7    -37645.58   1173939</span></span>
<span><span class="co">##  [4,]   2230028.1   900647.6    790310.82   3758650</span></span>
<span><span class="co">##  [5,]   3691095.9  1201650.8   1761276.09   5701639</span></span>
<span><span class="co">##  [6,]   9561369.2  2183081.0   6055215.06  13228795</span></span>
<span><span class="co">##  [7,]  20957144.4  3610684.4  15092490.22  26953460</span></span>
<span><span class="co">##  [8,]  33428879.0  4931632.4  25433851.64  41583251</span></span>
<span><span class="co">##  [9,]  46263909.9  6136563.8  36357479.01  56377102</span></span>
<span><span class="co">## [10,]  59065904.7  7160890.5  47441520.52  70937231</span></span>
<span><span class="co">## [11,] 176368263.7 12708050.9 155788022.09 197482374</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Roger Hayne, R. Mark Sharp.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>



  <script>
document.addEventListener('DOMContentLoaded', function() {
  var codeBlocks = document.querySelectorAll('div.sourceCode');
  codeBlocks.forEach(function(block) {
    var btn = document.createElement('button');
    btn.className = 'code-fold-btn';
    btn.innerHTML = '&#9654; Show Code';
    btn.onclick = function() {
      if (block.classList.contains('hidden')) {
        block.classList.remove('hidden');
        btn.innerHTML = '&#9660; Hide Code';
      } else {
        block.classList.add('hidden');
        btn.innerHTML = '&#9654; Show Code';
      }
    };
    block.classList.add('hidden');
    block.parentNode.insertBefore(btn, block);
  });
});
</script>
</body>
</html>
