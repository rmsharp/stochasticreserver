<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Comprehensive Tutorial: Stochastic Reserving Models ‚Ä¢ stochasticreserver</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Comprehensive Tutorial: Stochastic Reserving Models">
<style>
.code-fold-btn {
  cursor: pointer;
  padding: 0.25em 0.5em;
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 0.25rem;
  margin-bottom: 0.5em;
  font-size: 0.85em;
  display: inline-block;
}
.code-fold-btn:hover {
  background-color: #e9ecef;
}
.sourceCode.hidden {
  display: none;
}
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">stochasticreserver</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/comprehensive_tutorial.html">Comprehensive Tutorial</a></li>
    <li><a class="dropdown-item" href="../articles/stochastic_reserving.html">Example Stochastic Reserving</a></li>
    <li><a class="dropdown-item" href="../articles/manual.html">Manual</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Comprehensive Tutorial: Stochastic Reserving Models</h1>
                        <h4 data-toc-skip class="author">R. Mark
Sharp</h4>
            
            <h4 data-toc-skip class="date">2026-01-21</h4>
      

      <div class="d-none name"><code>comprehensive_tutorial.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial demonstrates all five stochastic reserving models
implemented in the <code>stochasticreserver</code> package: 1.
<strong>Chain Ladder</strong> - Standard development factor approach 2.
<strong>Cape Cod</strong> (Bornhuetter-Ferguson variant) -
Exposure-based method 3. <strong>Berquist-Sherman</strong> - Incremental
severity method with trend 4. <strong>Hoerl Curve</strong> - Smooth
curve with shared operational time parameters 5. <strong>Wright</strong>
- Generalized Hoerl with individual accident year levels</p>
<p>These methods are based on Roger Hayne‚Äôs paper <a href="https://variancejournal.org/article/120823" class="external-link">‚ÄúA Flexible Framework
for Stochastic Reserving Models‚Äù</a> published in <em>Variance</em>
journal (<a href="https://www.casact.org/sites/default/files/2021-08/Flexible-Framework-Hayne.pdf" class="external-link">PDF</a>).
The key insight is that all five methods can be unified under a common
maximum likelihood estimation framework, enabling consistent uncertainty
quantification.</p>
</div>
<div class="section level2">
<h2 id="theoretical-framework">Theoretical Framework<a class="anchor" aria-label="anchor" href="#theoretical-framework"></a>
</h2>
<div class="section level3">
<h3 id="uncertainty-in-loss-reserving">Uncertainty in Loss Reserving<a class="anchor" aria-label="anchor" href="#uncertainty-in-loss-reserving"></a>
</h3>
<p>Loss reserve estimates face three distinct sources of
uncertainty:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Process Uncertainty</strong> - Inherent stochastic
fluctuation in outcomes even when parameters are known exactly. This
represents the irreducible randomness in insurance claim
development.</p></li>
<li><p><strong>Parameter Uncertainty</strong> - Error from estimating
unknown parameters. Even with the correct model structure, finite data
leads to estimation error.</p></li>
<li><p><strong>Model Uncertainty</strong> - Risk that the assumed model
structure doesn‚Äôt match actual data-generating processes. Different
reserving methods may yield different estimates, revealing where
assumptions require investigation.</p></li>
</ol>
<p>This package addresses process and parameter uncertainty through
maximum likelihood estimation (MLE). Model uncertainty is addressed by
enabling comparison across multiple methods.</p>
</div>
<div class="section level3">
<h3 id="maximum-likelihood-estimation">Maximum Likelihood Estimation<a class="anchor" aria-label="anchor" href="#maximum-likelihood-estimation"></a>
</h3>
<p>MLEs have desirable asymptotic properties (as sample size
increases):</p>
<ul>
<li>
<strong>Consistency</strong>: Estimates converge to true parameter
values</li>
<li>
<strong>Efficiency</strong>: Variance achieves the theoretical lower
bound (Cram√©r-Rao)</li>
<li>
<strong>Asymptotic Normality</strong>: Distribution approaches
Gaussian with mean
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ∏</mi><annotation encoding="application/x-tex">\theta</annotation></semantics></math>
and covariance equal to the inverse Fisher information matrix</li>
</ul>
<p>The <strong>Fisher Information Matrix</strong> is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>E</mi><mrow><mo stretchy="true" form="prefix">[</mo><mfrac><msup><mi>‚àÇ</mi><mn>2</mn></msup><mrow><mi>‚àÇ</mi><msub><mi>Œ∏</mi><mi>i</mi></msub><mi>‚àÇ</mi><msub><mi>Œ∏</mi><mi>j</mi></msub></mrow></mfrac><mrow><mo stretchy="true" form="prefix">(</mo><mo>‚àí</mo><mo>ln</mo><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>X</mi><mo stretchy="false" form="prefix">|</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">I(\theta)_{ij} = E\left[\frac{\partial^2}{\partial\theta_i\partial\theta_j}
(-\ln L(X|\theta))\right]</annotation></semantics></math></p>
<p>This enables uncertainty quantification through the
variance-covariance matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ£</mi><mo>=</mo><mi>I</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\Sigma = I(\theta)^{-1}</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="stochastic-model-for-incremental-averages">Stochastic Model for Incremental Averages<a class="anchor" aria-label="anchor" href="#stochastic-model-for-incremental-averages"></a>
</h3>
<p>All models share a common likelihood structure. For incremental
averages
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">A_{ij}</annotation></semantics></math>
(where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
= accident year,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
= development lag), we assume:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>‚àº</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>g</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>œÉ</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">A_{ij} \sim N(g_{ij}(\theta), \sigma^2_{ij})</annotation></semantics></math></p>
<p>The expected value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g_{ij}(\theta)</annotation></semantics></math>
is model-specific (Chain Ladder, Cape Cod, etc.), while the variance
structure is shared:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>œÉ</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup><mo>=</mo><msup><mi>e</mi><mrow><mi>Œ∫</mi><mo>‚àí</mo><msub><mi>w</mi><mi>i</mi></msub></mrow></msup><mo>‚ãÖ</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>g</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">\sigma^2_{ij} = e^{\kappa - w_i} \cdot (g_{ij}(\theta)^2)^p</annotation></semantics></math></p>
<p>where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ∫</mi><annotation encoding="application/x-tex">\kappa</annotation></semantics></math>
is a proportionality constant</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">w_i = \log(d_i)</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mi>i</mi></msub><annotation encoding="application/x-tex">d_i</annotation></semantics></math>
is the exposure count for accident year
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
is a power parameter controlling heteroscedasticity</li>
</ul>
</div>
<div class="section level3">
<h3 id="negative-log-likelihood-function">Negative Log-Likelihood Function<a class="anchor" aria-label="anchor" href="#negative-log-likelihood-function"></a>
</h3>
<p>For a single observation, the negative log-likelihood is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>‚Ñì</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>;</mo><mi>Œº</mi><mo>,</mo><mi>Œ∫</mi><mo>,</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∫</mi><mo>‚àí</mo><mi>w</mi><mo>+</mo><mo>ln</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>œÄ</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>Œº</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>p</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>‚àí</mo><mi>Œº</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>e</mi><mrow><mi>Œ∫</mi><mo>‚àí</mo><mi>w</mi></mrow></msup><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>Œº</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>p</mi></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\ell(x; \mu, \kappa, p) = \frac{1}{2}\left(\kappa - w +
\ln(2\pi(\mu^2)^p)\right) + \frac{(x-\mu)^2}{2e^{\kappa-w}(\mu^2)^p}</annotation></semantics></math></p>
<p>The total objective function sums over all available cells in the
triangle.</p>
</div>
<div class="section level3">
<h3 id="the-five-model-forms">The Five Model Forms<a class="anchor" aria-label="anchor" href="#the-five-model-forms"></a>
</h3>
<p>Each model specifies a different expected value function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g_{ij}(\theta)</annotation></semantics></math>:
| Model | Expected Value Form | Parameters | |‚Äî‚Äî-|‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî|‚Äî‚Äî‚Äî‚Äî| |
<strong>Chain Ladder</strong> |
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ∏</mi><mi>j</mi></msub><mo>‚ãÖ</mo><msub><mi>U</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\theta_j \cdot U_i</annotation></semantics></math>
| Development proportions (sum to 1) | | <strong>Cape Cod</strong> |
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ∏</mi><mn>0</mn></msub><mo>‚ãÖ</mo><msubsup><mi>Œ∏</mi><mi>i</mi><mrow><mi>r</mi><mi>o</mi><mi>w</mi></mrow></msubsup><mo>‚ãÖ</mo><msubsup><mi>Œ∏</mi><mi>j</mi><mrow><mi>c</mi><mi>o</mi><mi>l</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\theta_0 \cdot \theta_i^{row} \cdot \theta_j^{col}</annotation></semantics></math>
| Level + row/column factors | | <strong>Berquist-Sherman</strong> |
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>‚ãÖ</mo><msup><mi>e</mi><mrow><msub><mi>Œ∏</mi><mrow><mi>t</mi><mi>r</mi><mi>e</mi><mi>n</mi><mi>d</mi></mrow></msub><mo>‚ãÖ</mo><mi>j</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\theta_i \cdot e^{\theta_{trend} \cdot j}</annotation></semantics></math>
| Year levels + trend | | <strong>Hoerl Curve</strong> |
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>e</mi><mrow><mi>Œ±</mi><mo>+</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><mi>œÑ</mi><mo>+</mo><msub><mi>Œ≤</mi><mn>2</mn></msub><msup><mi>œÑ</mi><mn>2</mn></msup><mo>+</mo><msub><mi>Œ≤</mi><mn>3</mn></msub><mo>ln</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>œÑ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>Œ≤</mi><mn>4</mn></msub><mi>i</mi></mrow></msup><annotation encoding="application/x-tex">e^{\alpha + \beta_1\tau + \beta_2\tau^2 + \beta_3\ln(\tau) + \beta_4 i}</annotation></semantics></math>
| Curve params + row trend | | <strong>Wright</strong> |
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>e</mi><mrow><msub><mi>Œ±</mi><mi>i</mi></msub><mo>+</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><mi>œÑ</mi><mo>+</mo><msub><mi>Œ≤</mi><mn>2</mn></msub><msup><mi>œÑ</mi><mn>2</mn></msup><mo>+</mo><msub><mi>Œ≤</mi><mn>3</mn></msub><mo>ln</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>œÑ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><annotation encoding="application/x-tex">e^{\alpha_i + \beta_1\tau + \beta_2\tau^2 + \beta_3\ln(\tau)}</annotation></semantics></math>
| Individual levels + curve |</p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œÑ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
represents operational time (development lag) and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>U</mi><mi>i</mi></msub><annotation encoding="application/x-tex">U_i</annotation></semantics></math>
represents the ultimate for accident year
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="gradient-and-hessian">Gradient and Hessian<a class="anchor" aria-label="anchor" href="#gradient-and-hessian"></a>
</h3>
<p>Efficient optimization requires analytical gradients and Hessians.
For parameter vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ùêö</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mn>1</mn></msub><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><msub><mi>Œ∏</mi><mi>k</mi></msub><mo>,</mo><mi>Œ∫</mi><mo>,</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{a} = (\theta_1, \ldots, \theta_k, \kappa, p)</annotation></semantics></math>:</p>
<p><strong>Gradient with respect to model parameters:</strong>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>‚àÇ</mi><mo>‚Ñì</mo></mrow><mrow><mi>‚àÇ</mi><mi>Œ∏</mi></mrow></mfrac><mo>=</mo><munder><mo>‚àë</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi></mrow></munder><mi>g</mi><msub><mi>‚Ä≤</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚ãÖ</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mi>p</mi><msub><mi>Œº</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mfrac><mo>+</mo><mfrac><mrow><msub><mi>Œº</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>‚àí</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><msubsup><mi>œÉ</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup></mfrac><mo>‚àí</mo><mfrac><mrow><mi>p</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>‚àí</mo><msub><mi>Œº</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><mrow><msubsup><mi>œÉ</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup><msub><mi>Œº</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{\partial \ell}{\partial \theta} = \sum_{i,j} g'_{ij}(\theta) \cdot
\left(\frac{p}{\mu_{ij}} + \frac{\mu_{ij} - A_{ij}}{\sigma^2_{ij}} -
\frac{p(A_{ij} - \mu_{ij})^2}{\sigma^2_{ij} \mu_{ij}}\right)</annotation></semantics></math></p>
<p><strong>Gradient with respect to variance parameters:</strong>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>‚àÇ</mi><mo>‚Ñì</mo></mrow><mrow><mi>‚àÇ</mi><mi>Œ∫</mi></mrow></mfrac><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><munder><mo>‚àë</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi></mrow></munder><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>‚àí</mo><msub><mi>Œº</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><msubsup><mi>œÉ</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{\partial \ell}{\partial \kappa} = \frac{1}{2}\sum_{i,j}
\left(1 - \frac{(A_{ij} - \mu_{ij})^2}{\sigma^2_{ij}}\right)</annotation></semantics></math></p>
<p>The Hessian matrix enables Newton-type optimization and provides the
information matrix for uncertainty quantification.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stochasticreserver</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">mvtnorm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">abind</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<div class="section level3">
<h3 id="package-data-haynes-example-triangle">Package Data: Hayne‚Äôs Example Triangle<a class="anchor" aria-label="anchor" href="#package-data-haynes-example-triangle"></a>
</h3>
<p>The package includes data from the reference paper - a 10x10
development triangle of cumulative averages (<code>B0</code>) and
exposure counts (<code>dnom</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the cumulative average triangle</span></span>
<span><span class="va">B0</span> <span class="op">&lt;-</span> <span class="fu">stochasticreserver</span><span class="fu">::</span><span class="va"><a href="../reference/B0.html">B0</a></span></span>
<span><span class="va">dnom</span> <span class="op">&lt;-</span> <span class="fu">stochasticreserver</span><span class="fu">::</span><span class="va"><a href="../reference/dnom.html">dnom</a></span></span>
<span><span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">B0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the triangle</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cumulative Average Triangle (B0):\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Cumulative Average Triangle (B0):</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">B0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         [,1]    [,2]    [,3]    [,4]    [,5]    [,6]    [,7]    [,8]    [,9]</span></span>
<span><span class="co">##  [1,] 670.26 1480.25 1938.54 2466.25 2837.85 3003.52 3055.39 3132.94 3141.19</span></span>
<span><span class="co">##  [2,] 767.99 1592.50 2463.79 3019.72 3374.73 3553.61 3602.28 3627.28 3645.57</span></span>
<span><span class="co">##  [3,] 740.58 1615.80 2345.85 2910.53 3201.52 3417.71 3506.59 3529.00      NA</span></span>
<span><span class="co">##  [4,] 862.12 1754.90 2534.78 3270.85 3739.89 4003.00 4125.31      NA      NA</span></span>
<span><span class="co">##  [5,] 840.94 1859.03 2804.55 3445.35 3950.47 4185.95      NA      NA      NA</span></span>
<span><span class="co">##  [6,] 848.00 2052.92 3076.14 3861.03 4351.58      NA      NA      NA      NA</span></span>
<span><span class="co">##  [7,] 901.77 1927.89 3003.59 3881.42      NA      NA      NA      NA      NA</span></span>
<span><span class="co">##  [8,] 935.20 2103.98 3181.75      NA      NA      NA      NA      NA      NA</span></span>
<span><span class="co">##  [9,] 759.32 1584.91      NA      NA      NA      NA      NA      NA      NA</span></span>
<span><span class="co">## [10,] 723.30      NA      NA      NA      NA      NA      NA      NA      NA</span></span>
<span><span class="co">##         [,10]</span></span>
<span><span class="co">##  [1,] 3159.73</span></span>
<span><span class="co">##  [2,]      NA</span></span>
<span><span class="co">##  [3,]      NA</span></span>
<span><span class="co">##  [4,]      NA</span></span>
<span><span class="co">##  [5,]      NA</span></span>
<span><span class="co">##  [6,]      NA</span></span>
<span><span class="co">##  [7,]      NA</span></span>
<span><span class="co">##  [8,]      NA</span></span>
<span><span class="co">##  [9,]      NA</span></span>
<span><span class="co">## [10,]      NA</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nExposure Counts (dnom):\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Exposure Counts (dnom):</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">dnom</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 39161 38672 41801 42263 41481 40214 43599 42118 43479 49492</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="data-preparation">Data Preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h3>
<p>We need to prepare several derived quantities for the models:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate incremental average matrix (A0)</span></span>
<span><span class="va">A0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">B0</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">B0</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="va">size</span><span class="op">]</span> <span class="op">-</span> <span class="va">B0</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate log exposure matrix for variance structure</span></span>
<span><span class="va">logd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">dnom</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create row and column index matrices</span></span>
<span><span class="va">rowNum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.html" class="external-link">row</a></span><span class="op">(</span><span class="va">A0</span><span class="op">)</span></span>
<span><span class="va">colNum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/col.html" class="external-link">col</a></span><span class="op">(</span><span class="va">A0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create masks for data availability</span></span>
<span><span class="co"># upper_triangle_mask: TRUE for cells with available data</span></span>
<span><span class="va">upper_triangle_mask</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="va">rowNum</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># msn: mask for next forecast diagonal (one-period ahead)</span></span>
<span><span class="va">msn</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="va">rowNum</span><span class="op">)</span> <span class="op">==</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">2</span></span>
<span></span>
<span><span class="co"># msd: mask for current diagonal (paid to date)</span></span>
<span><span class="va">msd</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="va">rowNum</span><span class="op">)</span> <span class="op">==</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Calculate amount paid to date for each accident year</span></span>
<span><span class="va">paid_to_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">B0</span> <span class="op">*</span> <span class="va">msd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Paid to Date by Accident Year:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Paid to Date by Accident Year:</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">paid_to_date</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 3159.73 3645.57 3529.00 4125.31 4185.95 4351.58 3881.42 3181.75 1584.91</span></span>
<span><span class="co">## [10]  723.30</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="simulated-data-auto-liability-example">Simulated Data: Auto Liability Example<a class="anchor" aria-label="anchor" href="#simulated-data-auto-liability-example"></a>
</h3>
<p>To demonstrate the models on different data characteristics, we also
create a simulated dataset representing a stylized auto liability
triangle. This simulated data exhibits: - Moderate development over 10
periods - Slight trend in accident year severity - Realistic exposure
variation</p>
<p><strong>Note:</strong> This data is simulated. For production use,
replace with actual public data such as triangles from regulatory
filings or industry studies.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate a second triangle with different characteristics</span></span>
<span><span class="va">simulate_triangle</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_years</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">base_ult</span> <span class="op">=</span> <span class="fl">5000</span>, <span class="va">trend</span> <span class="op">=</span> <span class="fl">0.03</span>,</span>
<span>                              <span class="va">dev_pattern</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">dev_pattern</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Typical auto liability development pattern</span></span>
<span>    <span class="va">dev_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.35</span>, <span class="fl">0.25</span>, <span class="fl">0.15</span>, <span class="fl">0.10</span>, <span class="fl">0.06</span>, <span class="fl">0.04</span>, <span class="fl">0.025</span>, <span class="fl">0.015</span>,</span>
<span>                     <span class="fl">0.008</span>, <span class="fl">0.002</span><span class="op">)</span></span>
<span>    <span class="va">dev_pattern</span> <span class="op">&lt;-</span> <span class="va">dev_pattern</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dev_pattern</span><span class="op">)</span>  <span class="co"># Normalize</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">n_dev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dev_pattern</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Generate ultimates with trend</span></span>
<span>  <span class="va">ultimates</span> <span class="op">&lt;-</span> <span class="va">base_ult</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">trend</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">n_years</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ultimates</span> <span class="op">&lt;-</span> <span class="va">ultimates</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_years</span>, <span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Add noise</span></span>
<span></span>
<span>  <span class="co"># Generate incremental averages</span></span>
<span>  <span class="va">incr_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n_years</span>, <span class="va">n_dev</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_years</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_dev</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">(</span><span class="va">n_years</span> <span class="op">-</span> <span class="va">i</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="op">(</span><span class="va">j</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">ultimates</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">dev_pattern</span><span class="op">[</span><span class="va">j</span><span class="op">]</span></span>
<span>        <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">mu</span> <span class="op">*</span> <span class="fl">0.1</span>  <span class="co"># 10% coefficient of variation</span></span>
<span>        <span class="va">incr_avg</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Convert to cumulative</span></span>
<span>  <span class="va">cum_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">incr_avg</span>, <span class="fl">1</span>, <span class="va">cumsum</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Generate exposures (claim counts)</span></span>
<span>  <span class="va">exposures</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_years</span>, <span class="fl">35000</span>, <span class="fl">50000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    B0 <span class="op">=</span> <span class="va">cum_avg</span>,</span>
<span>    A0 <span class="op">=</span> <span class="va">incr_avg</span>,</span>
<span>    dnom <span class="op">=</span> <span class="va">exposures</span>,</span>
<span>    ultimates <span class="op">=</span> <span class="va">ultimates</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu">simulate_triangle</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">B0_sim</span> <span class="op">&lt;-</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">B0</span></span>
<span><span class="va">A0_sim</span> <span class="op">&lt;-</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">A0</span></span>
<span><span class="va">dnom_sim</span> <span class="op">&lt;-</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">dnom</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Simulated Cumulative Triangle:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Simulated Cumulative Triangle:</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">B0_sim</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          [,1]    [,2]    [,3]    [,4]    [,5]    [,6]    [,7]    [,8]    [,9]</span></span>
<span><span class="co">##  [1,] 2118.72 3763.52 4455.18 4975.73 5292.73 5520.54 5650.60 5709.59 5741.97</span></span>
<span><span class="co">##  [2,] 1698.59 2727.28 3465.37 4026.84 4384.17 4575.81 4697.76 4759.62 4801.51</span></span>
<span><span class="co">##  [3,] 1769.59 3181.52 4048.89 4644.97 4949.33 5176.31 5288.17 5362.84      NA</span></span>
<span><span class="co">##  [4,] 1805.80 2875.26 3724.21 4299.76 4625.90 4868.57 4999.31      NA      NA</span></span>
<span><span class="co">##  [5,] 1734.85 3232.60 4024.08 4681.25 5010.93 5255.69      NA      NA      NA</span></span>
<span><span class="co">##  [6,] 2082.96 3411.40 4412.53 5026.17 5375.21      NA      NA      NA      NA</span></span>
<span><span class="co">##  [7,] 2315.96 4035.05 5009.57 5460.74      NA      NA      NA      NA      NA</span></span>
<span><span class="co">##  [8,] 2203.14 3677.04 4612.09      NA      NA      NA      NA      NA      NA</span></span>
<span><span class="co">##  [9,] 2594.93 4591.72      NA      NA      NA      NA      NA      NA      NA</span></span>
<span><span class="co">## [10,] 2110.66      NA      NA      NA      NA      NA      NA      NA      NA</span></span>
<span><span class="co">##        [,10]</span></span>
<span><span class="co">##  [1,] 5754.1</span></span>
<span><span class="co">##  [2,]     NA</span></span>
<span><span class="co">##  [3,]     NA</span></span>
<span><span class="co">##  [4,]     NA</span></span>
<span><span class="co">##  [5,]     NA</span></span>
<span><span class="co">##  [6,]     NA</span></span>
<span><span class="co">##  [7,]     NA</span></span>
<span><span class="co">##  [8,]     NA</span></span>
<span><span class="co">##  [9,]     NA</span></span>
<span><span class="co">## [10,]     NA</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="helper-functions">Helper Functions<a class="anchor" aria-label="anchor" href="#helper-functions"></a>
</h2>
<p>We define helper functions to streamline the analysis across all
models.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Fit a stochastic reserving model</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param model_name Character: "Chain", "CapeCod", "Berquist", "Hoerl",</span></span>
<span><span class="co">#'   or "Wright"</span></span>
<span><span class="co">#' @param B0 Cumulative average matrix</span></span>
<span><span class="co">#' @param A0 Incremental average matrix</span></span>
<span><span class="co">#' @param dnom Exposure vector</span></span>
<span><span class="co">#' @param paid_to_date Paid amounts to date</span></span>
<span><span class="co">#' @param upper_triangle_mask Logical mask for available data</span></span>
<span><span class="co">#' @return List with fitted model results</span></span>
<span><span class="va">fit_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_name</span>, <span class="va">B0</span>, <span class="va">A0</span>, <span class="va">dnom</span>, <span class="va">paid_to_date</span>,</span>
<span>                      <span class="va">upper_triangle_mask</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">B0</span><span class="op">)</span></span>
<span>  <span class="va">logd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">dnom</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Select model</span></span>
<span>  <span class="va">model_lst</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">model_name</span>,</span>
<span>    <span class="st">"Chain"</span> <span class="op">=</span> <span class="fu"><a href="../reference/chain.html">chain</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span>,</span>
<span>    <span class="st">"CapeCod"</span> <span class="op">=</span> <span class="fu"><a href="../reference/capecod.html">capecod</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span>,</span>
<span>    <span class="st">"Berquist"</span> <span class="op">=</span> <span class="fu"><a href="../reference/berquist.html">berquist</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span>,</span>
<span>    <span class="st">"Hoerl"</span> <span class="op">=</span> <span class="fu"><a href="../reference/hoerl.html">hoerl</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span>,</span>
<span>    <span class="st">"Wright"</span> <span class="op">=</span> <span class="fu"><a href="../reference/wright.html">wright</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">g_obj</span> <span class="op">&lt;-</span> <span class="va">model_lst</span><span class="op">$</span><span class="va">g_obj</span></span>
<span>  <span class="va">g_grad</span> <span class="op">&lt;-</span> <span class="va">model_lst</span><span class="op">$</span><span class="va">g_grad</span></span>
<span>  <span class="va">g_hess</span> <span class="op">&lt;-</span> <span class="va">model_lst</span><span class="op">$</span><span class="va">g_hess</span></span>
<span>  <span class="va">a0</span> <span class="op">&lt;-</span> <span class="va">model_lst</span><span class="op">$</span><span class="va">a0</span></span>
<span></span>
<span>  <span class="co"># Get starting values for kappa and p</span></span>
<span>  <span class="va">E</span> <span class="op">&lt;-</span> <span class="fu">g_obj</span><span class="op">(</span><span class="va">a0</span><span class="op">)</span></span>
<span>  <span class="va">yyy</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">A0</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">yyy</span> <span class="op">&lt;-</span> <span class="va">logd</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="va">yyy</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="va">yyy</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">yyy</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">E</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yyy</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sss</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ttt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">sss</span><span class="op">$</span><span class="va">y</span> <span class="op">~</span> <span class="va">sss</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">ttt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">a0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">a0</span>, <span class="va">ttt</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Objective functions</span></span>
<span>  <span class="va">l.obj</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/make_negative_log_likelihood.html">make_negative_log_likelihood</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span>, <span class="va">dnom</span>, <span class="va">g_obj</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">l.grad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/make_gradient_of_objective.html">make_gradient_of_objective</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span>, <span class="va">dnom</span>, <span class="va">g_obj</span>, <span class="va">g_grad</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">l.hess</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/make_log_hessian.html">make_log_hessian</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">A</span>, <span class="va">dnom</span>, <span class="va">g_obj</span>, <span class="va">g_grad</span>, <span class="va">g_hess</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Minimize</span></span>
<span>  <span class="va">max_ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>iter.max <span class="op">=</span> <span class="fl">10000</span>, eval.max <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>  <span class="va">scale_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="va">a0</span> <span class="op">*</span> <span class="op">(</span><span class="va">a0</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="va">a0</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">mle</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">a0</span>, <span class="va">l.obj</span>, gradient <span class="op">=</span> <span class="va">l.grad</span>, hessian <span class="op">=</span> <span class="va">l.hess</span>,</span>
<span>           scale <span class="op">=</span> <span class="va">scale_vec</span>, A <span class="op">=</span> <span class="va">A0</span>, control <span class="op">=</span> <span class="va">max_ctrl</span><span class="op">)</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Fallback without hessian</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">a0</span>, <span class="va">l.obj</span>, gradient <span class="op">=</span> <span class="va">l.grad</span>,</span>
<span>             scale <span class="op">=</span> <span class="va">scale_vec</span>, A <span class="op">=</span> <span class="va">A0</span>, control <span class="op">=</span> <span class="va">max_ctrl</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract results</span></span>
<span>  <span class="va">npar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">mean_fitted</span> <span class="op">&lt;-</span> <span class="fu">g_obj</span><span class="op">(</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">var_fitted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">logd</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">size</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span></span>
<span>    <span class="op">(</span><span class="va">mean_fitted</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="va">p</span></span>
<span>  <span class="va">stres</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">A0</span> <span class="op">-</span> <span class="va">mean_fitted</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">var_fitted</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Information matrix and variance-covariance</span></span>
<span>  <span class="va">hess_final</span> <span class="op">&lt;-</span> <span class="fu">l.hess</span><span class="op">(</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span>, <span class="va">A0</span><span class="op">)</span></span>
<span>  <span class="va">inf_mat</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">hess_final</span><span class="op">)</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    model_name <span class="op">=</span> <span class="va">model_name</span>,</span>
<span>    mle <span class="op">=</span> <span class="va">mle</span>,</span>
<span>    npar <span class="op">=</span> <span class="va">npar</span>,</span>
<span>    mean <span class="op">=</span> <span class="va">mean_fitted</span>,</span>
<span>    var <span class="op">=</span> <span class="va">var_fitted</span>,</span>
<span>    stres <span class="op">=</span> <span class="va">stres</span>,</span>
<span>    g_obj <span class="op">=</span> <span class="va">g_obj</span>,</span>
<span>    vcov <span class="op">=</span> <span class="va">inf_mat</span>,</span>
<span>    logd <span class="op">=</span> <span class="va">logd</span>,</span>
<span>    convergence <span class="op">=</span> <span class="va">mle</span><span class="op">$</span><span class="va">convergence</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Calculate forecast reserves</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param fit Fitted model object</span></span>
<span><span class="co">#' @param dnom Exposure vector</span></span>
<span><span class="co">#' @param upper_triangle_mask Mask for available data</span></span>
<span><span class="co">#' @return Data frame with reserve estimates</span></span>
<span><span class="va">calculate_reserves</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">dnom</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Forecast for lower triangle (future payments)</span></span>
<span>  <span class="va">forecast_mask</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="va">upper_triangle_mask</span></span>
<span>  <span class="va">forecast_mean</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">mean</span> <span class="op">*</span> <span class="va">forecast_mask</span></span>
<span>  <span class="va">forecast_var</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">var</span> <span class="op">*</span> <span class="va">forecast_mask</span></span>
<span></span>
<span>  <span class="co"># Total reserve by accident year</span></span>
<span>  <span class="va">reserve_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">dnom</span> <span class="op">*</span> <span class="va">forecast_mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">reserve_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">dnom</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">forecast_var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Aggregate</span></span>
<span>  <span class="va">total_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">reserve_mean</span><span class="op">)</span></span>
<span>  <span class="va">total_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dnom</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">forecast_var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    accident_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span>, <span class="st">"Total"</span><span class="op">)</span>,</span>
<span>    reserve_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">reserve_mean</span>, <span class="va">total_mean</span><span class="op">)</span>,</span>
<span>    reserve_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">reserve_sd</span>, <span class="va">total_sd</span><span class="op">)</span>,</span>
<span>    cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">reserve_sd</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">reserve_mean</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">total_sd</span> <span class="op">/</span> <span class="va">total_mean</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Run Monte Carlo simulation</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param fit Fitted model object</span></span>
<span><span class="co">#' @param dnom Exposure vector</span></span>
<span><span class="co">#' @param upper_triangle_mask Mask for available data</span></span>
<span><span class="co">#' @param nsim Number of simulations</span></span>
<span><span class="co">#' @return Matrix of simulated reserves</span></span>
<span><span class="va">run_simulation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">dnom</span>, <span class="va">upper_triangle_mask</span>, <span class="va">nsim</span> <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">vcov</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span>
<span>  <span class="va">npar</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">npar</span></span>
<span></span>
<span>  <span class="co"># Masks for simulation</span></span>
<span>  <span class="va">smsk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">upper_triangle_mask</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">size</span>, <span class="va">nsim</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Sample parameters</span></span>
<span>  <span class="va">spar</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="va">fit</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span>, <span class="va">fit</span><span class="op">$</span><span class="va">vcov</span><span class="op">)</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">spar</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Simulated means</span></span>
<span>  <span class="va">esim</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="fu">g_obj</span><span class="op">(</span><span class="va">spar</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Simulated variances</span></span>
<span>  <span class="va">ksim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">spar</span><span class="op">[</span>, <span class="va">npar</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">dnom</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">psim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">spar</span><span class="op">[</span>, <span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">vsim</span> <span class="op">&lt;-</span> <span class="va">ksim</span> <span class="op">*</span> <span class="op">(</span><span class="va">esim</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="va">psim</span></span>
<span></span>
<span>  <span class="co"># Simulate future averages</span></span>
<span>  <span class="va">sim_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nsim</span> <span class="op">*</span> <span class="va">size</span> <span class="op">*</span> <span class="va">size</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">esim</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vsim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nsim</span>, <span class="va">size</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate reserves</span></span>
<span>  <span class="va">sdnm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">dnom</span>, <span class="va">size</span>, <span class="va">nsim</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">reserves</span> <span class="op">&lt;-</span> <span class="va">sdnm</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">sim_avg</span> <span class="op">*</span> <span class="op">!</span><span class="va">smsk</span>, dims <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">reserves</span>, Total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">reserves</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-fitting-all-five-methods">Model Fitting: All Five Methods<a class="anchor" aria-label="anchor" href="#model-fitting-all-five-methods"></a>
</h2>
<p>Now we fit all five models to the Hayne example data.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Chain"</span>, <span class="st">"CapeCod"</span>, <span class="st">"Berquist"</span>, <span class="st">"Hoerl"</span>, <span class="st">"Wright"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="va">model_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Fitting"</span>, <span class="va">model_name</span>, <span class="st">"model...\n"</span><span class="op">)</span></span>
<span>  <span class="va">results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">fit_model</span><span class="op">(</span></span>
<span>    <span class="va">model_name</span>, <span class="va">B0</span>, <span class="va">A0</span>, <span class="va">dnom</span>, <span class="va">paid_to_date</span>, <span class="va">upper_triangle_mask</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Convergence:"</span>, <span class="va">results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">convergence</span>,</span>
<span>      <span class="st">" Parameters:"</span>, <span class="va">results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Fitting Chain model...</span></span></code></pre>
<pre><code><span><span class="co">##   Convergence: 0  Parameters: 11 </span></span>
<span><span class="co">## Fitting CapeCod model...</span></span></code></pre>
<pre><code><span><span class="co">##   Convergence: 0  Parameters: 21 </span></span>
<span><span class="co">## Fitting Berquist model...</span></span>
<span><span class="co">##   Convergence: 0  Parameters: 13 </span></span>
<span><span class="co">## Fitting Hoerl model...</span></span>
<span><span class="co">##   Convergence: 0  Parameters: 7 </span></span>
<span><span class="co">## Fitting Wright model...</span></span>
<span><span class="co">##   Convergence: 0  Parameters: 15</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="model-1-chain-ladder">Model 1: Chain Ladder<a class="anchor" aria-label="anchor" href="#model-1-chain-ladder"></a>
</h2>
<p>The Chain Ladder model represents the standard actuarial approach
where development factors link successive development periods. In this
stochastic formulation, the expected emergence is parameterized such
that development proportions sum to 1.</p>
<div class="section level3">
<h3 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chain_fit</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="st">"Chain"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Chain Ladder Model\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Chain Ladder Model</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"==================\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ==================</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of parameters:"</span>, <span class="va">chain_fit</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of parameters: 11</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Model parameters:"</span>, <span class="va">chain_fit</span><span class="op">$</span><span class="va">npar</span>, <span class="st">"(development proportions)\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Model parameters: 9 (development proportions)</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Variance parameters: 2 (kappa, p)\n\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Variance parameters: 2 (kappa, p)</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Development pattern implied</span></span>
<span><span class="va">npar</span> <span class="op">&lt;-</span> <span class="va">chain_fit</span><span class="op">$</span><span class="va">npar</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="va">chain_fit</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">npar</span><span class="op">]</span></span>
<span><span class="va">dev_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">theta</span>, <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Implied development pattern:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Implied development pattern:</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dev_pattern</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Lag"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dev_pattern</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">dev_pattern</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Lag1   Lag2   Lag3   Lag4   Lag5   Lag6   Lag7   Lag8   Lag9  Lag10 </span></span>
<span><span class="co">## 0.1955 0.2307 0.2077 0.1637 0.1043 0.0555 0.0217 0.0132 0.0030 0.0047</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCumulative:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">dev_pattern</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Cumulative: 0.1955 0.4262 0.6339 0.7976 0.9019 0.9574 0.9791 0.9922 0.9953 1</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="fitted-values">Fitted Values<a class="anchor" aria-label="anchor" href="#fitted-values"></a>
</h3>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nFitted Mean (expected incremental averages):\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Fitted Mean (expected incremental averages):</span></span></code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">chain_fit</span><span class="op">$</span><span class="va">mean</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         [,1]    [,2]    [,3]   [,4]   [,5]   [,6]   [,7]  [,8]  [,9] [,10]</span></span>
<span><span class="co">##  [1,] 617.57  729.07  656.33 517.19 329.57 175.45  68.44 41.59  9.51 15.00</span></span>
<span><span class="co">##  [2,] 715.93  845.18  760.86 599.57 382.05 203.39  79.34 48.21 11.03 17.39</span></span>
<span><span class="co">##  [3,] 695.14  820.64  738.77 582.16 370.96 197.49  77.04 46.81 10.71 16.89</span></span>
<span><span class="co">##  [4,] 823.53  972.20  875.21 689.67 439.47 233.96  91.26 55.46 12.69 20.00</span></span>
<span><span class="co">##  [5,] 854.54 1008.81  908.16 715.64 456.02 242.77  94.70 57.55 13.16 20.76</span></span>
<span><span class="co">##  [6,] 943.04 1113.30 1002.22 789.76 503.25 267.91 104.51 63.51 14.53 22.91</span></span>
<span><span class="co">##  [7,] 951.15 1122.87 1010.84 796.55 507.58 270.22 105.41 64.05 14.65 23.11</span></span>
<span><span class="co">##  [8,] 981.03 1158.13 1042.59 821.57 523.52 278.70 108.72 66.07 15.11 23.83</span></span>
<span><span class="co">##  [9,] 726.85  858.06  772.46 608.70 387.88 206.49  80.55 48.95 11.20 17.66</span></span>
<span><span class="co">## [10,] 723.30  853.88  768.69 605.74 385.99 205.48  80.16 48.71 11.14 17.57</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="reserve-estimates">Reserve Estimates<a class="anchor" aria-label="anchor" href="#reserve-estimates"></a>
</h3>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chain_reserves</span> <span class="op">&lt;-</span> <span class="fu">calculate_reserves</span><span class="op">(</span><span class="va">chain_fit</span>, <span class="va">dnom</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">chain_reserves</span>, digits <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Chain Ladder Reserve Estimates"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Chain Ladder Reserve Estimates</caption>
<thead><tr class="header">
<th align="left">accident_year</th>
<th align="right">reserve_mean</th>
<th align="right">reserve_sd</th>
<th align="right">cv</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">672557</td>
<td align="right">473869</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">1153495</td>
<td align="right">628724</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">3725552</td>
<td align="right">1068158</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">7722556</td>
<td align="right">1489549</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">19036072</td>
<td align="right">2214503</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">42945172</td>
<td align="right">3195515</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">77393393</td>
<td align="right">4157471</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">92779952</td>
<td align="right">4551418</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">147356872</td>
<td align="right">5671774</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Total</td>
<td align="right">392785621</td>
<td align="right">9447957</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="model-2-cape-cod-bornhuetter-ferguson">Model 2: Cape Cod (Bornhuetter-Ferguson)<a class="anchor" aria-label="anchor" href="#model-2-cape-cod-bornhuetter-ferguson"></a>
</h2>
<p>The Cape Cod model incorporates exposure information through a
multiplicative structure with row (accident year) and column
(development) factors. This allows for prior information about ultimate
severity levels.</p>
<div class="section level3">
<h3 id="parameters-1">Parameters<a class="anchor" aria-label="anchor" href="#parameters-1"></a>
</h3>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cc_fit</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="st">"CapeCod"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cape Cod Model\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Cape Cod Model</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"==============\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ==============</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of parameters:"</span>, <span class="va">cc_fit</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of parameters: 21</span></span></code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Model parameters:"</span>, <span class="va">cc_fit</span><span class="op">$</span><span class="va">npar</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Model parameters: 19</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    - 1 level parameter\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - 1 level parameter</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    -"</span>, <span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="st">"row factors\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - 9 row factors</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    -"</span>, <span class="op">(</span><span class="va">size</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="st">"column factors\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - 9 column factors</span></span></code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Variance parameters: 2\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Variance parameters: 2</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="reserve-estimates-1">Reserve Estimates<a class="anchor" aria-label="anchor" href="#reserve-estimates-1"></a>
</h3>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cc_reserves</span> <span class="op">&lt;-</span> <span class="fu">calculate_reserves</span><span class="op">(</span><span class="va">cc_fit</span>, <span class="va">dnom</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">cc_reserves</span>, digits <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Cape Cod Reserve Estimates"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Cape Cod Reserve Estimates</caption>
<thead><tr class="header">
<th align="left">accident_year</th>
<th align="right">reserve_mean</th>
<th align="right">reserve_sd</th>
<th align="right">cv</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">675487</td>
<td align="right">478362</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">1154053</td>
<td align="right">633975</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">3705613</td>
<td align="right">1071770</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">7709391</td>
<td align="right">1494876</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">19040687</td>
<td align="right">2219174</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">42938949</td>
<td align="right">3196213</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">77307054</td>
<td align="right">4150959</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">92581984</td>
<td align="right">4542194</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">147002026</td>
<td align="right">5656751</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Total</td>
<td align="right">392115245</td>
<td align="right">9434799</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="model-3-berquist-sherman">Model 3: Berquist-Sherman<a class="anchor" aria-label="anchor" href="#model-3-berquist-sherman"></a>
</h2>
<p>The Berquist-Sherman model is an incremental severity method that
explicitly models trend over development periods. This is particularly
useful when development patterns are changing over time.</p>
<div class="section level3">
<h3 id="parameters-2">Parameters<a class="anchor" aria-label="anchor" href="#parameters-2"></a>
</h3>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">berq_fit</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="st">"Berquist"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Berquist-Sherman Model\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Berquist-Sherman Model</span></span></code></pre>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"======================\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ======================</span></span></code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of parameters:"</span>, <span class="va">berq_fit</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of parameters: 13</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Model parameters:"</span>, <span class="va">berq_fit</span><span class="op">$</span><span class="va">npar</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Model parameters: 11</span></span></code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    -"</span>, <span class="va">size</span>, <span class="st">"accident year averages\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - 10 accident year averages</span></span></code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    - 1 trend parameter\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - 1 trend parameter</span></span></code></pre>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Variance parameters: 2\n\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Variance parameters: 2</span></span></code></pre>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract trend parameter</span></span>
<span><span class="va">trend_param</span> <span class="op">&lt;-</span> <span class="va">berq_fit</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="va">size</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Estimated trend parameter:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">trend_param</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Estimated trend parameter: 0.0452</span></span></code></pre>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"This implies"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">trend_param</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="st">"% change per development period\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## This implies 4.62 % change per development period</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="reserve-estimates-2">Reserve Estimates<a class="anchor" aria-label="anchor" href="#reserve-estimates-2"></a>
</h3>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">berq_reserves</span> <span class="op">&lt;-</span> <span class="fu">calculate_reserves</span><span class="op">(</span><span class="va">berq_fit</span>, <span class="va">dnom</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">berq_reserves</span>, digits <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Berquist-Sherman Reserve Estimates"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Berquist-Sherman Reserve Estimates</caption>
<thead><tr class="header">
<th align="left">accident_year</th>
<th align="right">reserve_mean</th>
<th align="right">reserve_sd</th>
<th align="right">cv</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">643872</td>
<td align="right">337239</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">1258406</td>
<td align="right">465360</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">3553041</td>
<td align="right">889597</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">7338748</td>
<td align="right">1384118</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">17011031</td>
<td align="right">2408663</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">40234557</td>
<td align="right">4133010</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">74139470</td>
<td align="right">6077538</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">126323652</td>
<td align="right">8355660</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">209606332</td>
<td align="right">11101836</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Total</td>
<td align="right">480109108</td>
<td align="right">15997662</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="model-4-hoerl-curve">Model 4: Hoerl Curve<a class="anchor" aria-label="anchor" href="#model-4-hoerl-curve"></a>
</h2>
<p>The Hoerl model uses a smooth mathematical curve to describe
development rather than discrete factors. The curve includes polynomial
and logarithmic terms in operational time, plus a row trend.</p>
<div class="section level3">
<h3 id="mathematical-form">Mathematical Form<a class="anchor" aria-label="anchor" href="#mathematical-form"></a>
</h3>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œº</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo>+</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><msub><mi>œÑ</mi><mi>j</mi></msub><mo>+</mo><msub><mi>Œ≤</mi><mn>2</mn></msub><msubsup><mi>œÑ</mi><mi>j</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>Œ≤</mi><mn>3</mn></msub><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>œÑ</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>Œ≤</mi><mn>4</mn></msub><mo>‚ãÖ</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu_{ij} = \exp(\alpha + \beta_1 \tau_j + \beta_2 \tau_j^2 +
\beta_3 \log(\tau_j) + \beta_4 \cdot i)</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>œÑ</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\tau_j</annotation></semantics></math>
is the development lag (operational time).</p>
</div>
<div class="section level3">
<h3 id="parameters-3">Parameters<a class="anchor" aria-label="anchor" href="#parameters-3"></a>
</h3>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hoerl_fit</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="st">"Hoerl"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Hoerl Curve Model\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Hoerl Curve Model</span></span></code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=================\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## =================</span></span></code></pre>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of parameters:"</span>, <span class="va">hoerl_fit</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of parameters: 7</span></span></code></pre>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Model parameters:"</span>, <span class="va">hoerl_fit</span><span class="op">$</span><span class="va">npar</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Model parameters: 5</span></span></code></pre>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    - alpha (intercept)\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - alpha (intercept)</span></span></code></pre>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    - beta1 (linear in tau)\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - beta1 (linear in tau)</span></span></code></pre>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    - beta2 (quadratic in tau)\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - beta2 (quadratic in tau)</span></span></code></pre>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    - beta3 (log tau)\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - beta3 (log tau)</span></span></code></pre>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    - beta4 (row trend)\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - beta4 (row trend)</span></span></code></pre>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Variance parameters: 2\n\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Variance parameters: 2</span></span></code></pre>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hoerl_theta</span> <span class="op">&lt;-</span> <span class="va">hoerl_fit</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hoerl_theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta1"</span>, <span class="st">"beta2"</span>, <span class="st">"beta3"</span>, <span class="st">"beta4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">hoerl_theta</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   alpha   beta1   beta2   beta3   beta4 </span></span>
<span><span class="co">##  6.4977  0.0034 -0.0652  0.5984  0.0430</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="reserve-estimates-3">Reserve Estimates<a class="anchor" aria-label="anchor" href="#reserve-estimates-3"></a>
</h3>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hoerl_reserves</span> <span class="op">&lt;-</span> <span class="fu">calculate_reserves</span><span class="op">(</span><span class="va">hoerl_fit</span>, <span class="va">dnom</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">hoerl_reserves</span>, digits <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Hoerl Curve Reserve Estimates"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Hoerl Curve Reserve Estimates</caption>
<thead><tr class="header">
<th align="left">accident_year</th>
<th align="right">reserve_mean</th>
<th align="right">reserve_sd</th>
<th align="right">cv</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">169866</td>
<td align="right">296971</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">810147</td>
<td align="right">652176</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">2690392</td>
<td align="right">1195122</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">7354087</td>
<td align="right">1986075</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">17306357</td>
<td align="right">3060366</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">40013505</td>
<td align="right">4670729</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">72642848</td>
<td align="right">6311653</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">124351004</td>
<td align="right">8275308</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">207051137</td>
<td align="right">10691966</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Total</td>
<td align="right">472389343</td>
<td align="right">16115325</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="model-5-wright-generalized-hoerl">Model 5: Wright (Generalized Hoerl)<a class="anchor" aria-label="anchor" href="#model-5-wright-generalized-hoerl"></a>
</h2>
<p>The Wright model extends the Hoerl curve by allowing individual level
parameters for each accident year rather than just a linear trend. This
provides more flexibility at the cost of additional parameters.</p>
<div class="section level3">
<h3 id="mathematical-form-1">Mathematical Form<a class="anchor" aria-label="anchor" href="#mathematical-form-1"></a>
</h3>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œº</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ±</mi><mi>i</mi></msub><mo>+</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><msub><mi>œÑ</mi><mi>j</mi></msub><mo>+</mo><msub><mi>Œ≤</mi><mn>2</mn></msub><msubsup><mi>œÑ</mi><mi>j</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>Œ≤</mi><mn>3</mn></msub><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>œÑ</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu_{ij} = \exp(\alpha_i + \beta_1 \tau_j + \beta_2 \tau_j^2 +
\beta_3 \log(\tau_j))</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ±</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\alpha_i</annotation></semantics></math>
is an individual intercept for each accident year.</p>
</div>
<div class="section level3">
<h3 id="parameters-4">Parameters<a class="anchor" aria-label="anchor" href="#parameters-4"></a>
</h3>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wright_fit</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="st">"Wright"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Wright Model\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Wright Model</span></span></code></pre>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"============\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ============</span></span></code></pre>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of parameters:"</span>, <span class="va">wright_fit</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of parameters: 15</span></span></code></pre>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Model parameters:"</span>, <span class="va">wright_fit</span><span class="op">$</span><span class="va">npar</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Model parameters: 13</span></span></code></pre>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    -"</span>, <span class="va">size</span>, <span class="st">"individual year levels (alpha_i)\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - 10 individual year levels (alpha_i)</span></span></code></pre>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"    - 3 operational time parameters (beta1, beta2, beta3)\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     - 3 operational time parameters (beta1, beta2, beta3)</span></span></code></pre>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Variance parameters: 2\n\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   - Variance parameters: 2</span></span></code></pre>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wright_theta</span> <span class="op">&lt;-</span> <span class="va">wright_fit</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">wright_fit</span><span class="op">$</span><span class="va">npar</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Accident year levels:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Accident year levels:</span></span></code></pre>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">wright_theta</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 6.3169 6.4758 6.4403 6.5919 6.6407 6.7428 6.7468 6.7756 6.4808 6.4732</span></span></code></pre>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nOperational time parameters:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Operational time parameters:</span></span></code></pre>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">wright_theta</span><span class="op">[</span><span class="op">(</span><span class="va">size</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">size</span> <span class="op">+</span> <span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta1"</span>, <span class="st">"beta2"</span>, <span class="st">"beta3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">wright_theta</span><span class="op">[</span><span class="op">(</span><span class="va">size</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">size</span> <span class="op">+</span> <span class="fl">3</span><span class="op">)</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  0.1864 -0.0776  0.2975</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="reserve-estimates-4">Reserve Estimates<a class="anchor" aria-label="anchor" href="#reserve-estimates-4"></a>
</h3>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wright_reserves</span> <span class="op">&lt;-</span> <span class="fu">calculate_reserves</span><span class="op">(</span><span class="va">wright_fit</span>, <span class="va">dnom</span>, <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">wright_reserves</span>, digits <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Wright Model Reserve Estimates"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Wright Model Reserve Estimates</caption>
<thead><tr class="header">
<th align="left">accident_year</th>
<th align="right">reserve_mean</th>
<th align="right">reserve_sd</th>
<th align="right">cv</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">137270</td>
<td align="right">432966</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">646137</td>
<td align="right">800325</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">2533412</td>
<td align="right">1306997</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">7277123</td>
<td align="right">1888006</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">18702982</td>
<td align="right">2609470</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">42231067</td>
<td align="right">3524225</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">75946730</td>
<td align="right">4334693</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">92611271</td>
<td align="right">4768645</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">146554330</td>
<td align="right">5807424</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Total</td>
<td align="right">386640322</td>
<td align="right">10029257</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="model-comparison">Model Comparison<a class="anchor" aria-label="anchor" href="#model-comparison"></a>
</h2>
<div class="section level3">
<h3 id="reserve-estimates-comparison">Reserve Estimates Comparison<a class="anchor" aria-label="anchor" href="#reserve-estimates-comparison"></a>
</h3>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Accident_Year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">size</span>,</span>
<span>  Chain <span class="op">=</span> <span class="va">chain_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span><span class="op">]</span>,</span>
<span>  CapeCod <span class="op">=</span> <span class="va">cc_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span><span class="op">]</span>,</span>
<span>  Berquist <span class="op">=</span> <span class="va">berq_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span><span class="op">]</span>,</span>
<span>  Hoerl <span class="op">=</span> <span class="va">hoerl_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span><span class="op">]</span>,</span>
<span>  Wright <span class="op">=</span> <span class="va">wright_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add totals</span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">comparison</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Accident_Year <span class="op">=</span> <span class="st">"Total"</span>,</span>
<span>    Chain <span class="op">=</span> <span class="va">chain_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="va">size</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>    CapeCod <span class="op">=</span> <span class="va">cc_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="va">size</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Berquist <span class="op">=</span> <span class="va">berq_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="va">size</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Hoerl <span class="op">=</span> <span class="va">hoerl_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="va">size</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Wright <span class="op">=</span> <span class="va">wright_reserves</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="va">size</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">comparison</span>, digits <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Reserve Comparison Across Models"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Reserve Comparison Across Models</caption>
<thead><tr class="header">
<th align="left">Accident_Year</th>
<th align="right">Chain</th>
<th align="right">CapeCod</th>
<th align="right">Berquist</th>
<th align="right">Hoerl</th>
<th align="right">Wright</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">672557</td>
<td align="right">675487</td>
<td align="right">643872</td>
<td align="right">169866</td>
<td align="right">137270</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">1153495</td>
<td align="right">1154053</td>
<td align="right">1258406</td>
<td align="right">810147</td>
<td align="right">646137</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">3725552</td>
<td align="right">3705613</td>
<td align="right">3553041</td>
<td align="right">2690392</td>
<td align="right">2533412</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">7722556</td>
<td align="right">7709391</td>
<td align="right">7338748</td>
<td align="right">7354087</td>
<td align="right">7277123</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">19036072</td>
<td align="right">19040687</td>
<td align="right">17011031</td>
<td align="right">17306357</td>
<td align="right">18702982</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">42945172</td>
<td align="right">42938949</td>
<td align="right">40234557</td>
<td align="right">40013505</td>
<td align="right">42231067</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">77393393</td>
<td align="right">77307054</td>
<td align="right">74139470</td>
<td align="right">72642848</td>
<td align="right">75946730</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">92779952</td>
<td align="right">92581984</td>
<td align="right">126323652</td>
<td align="right">124351004</td>
<td align="right">92611271</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">147356872</td>
<td align="right">147002026</td>
<td align="right">209606332</td>
<td align="right">207051137</td>
<td align="right">146554330</td>
</tr>
<tr class="odd">
<td align="left">Total</td>
<td align="right">392785621</td>
<td align="right">392115245</td>
<td align="right">480109108</td>
<td align="right">472389343</td>
<td align="right">386640322</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="parameter-count-comparison">Parameter Count Comparison<a class="anchor" aria-label="anchor" href="#parameter-count-comparison"></a>
</h3>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">param_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Model <span class="op">=</span> <span class="va">model_names</span>,</span>
<span>  Model_Params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">npar</span><span class="op">)</span>,</span>
<span>  Variance_Params <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  Total_Params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  Convergence <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">param_df</span>, caption <span class="op">=</span> <span class="st">"Parameter Count by Model"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Parameter Count by Model</caption>
<colgroup>
<col width="12%">
<col width="12%">
<col width="18%">
<col width="22%">
<col width="18%">
<col width="16%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Model</th>
<th align="right">Model_Params</th>
<th align="right">Variance_Params</th>
<th align="right">Total_Params</th>
<th align="right">Convergence</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Chain</td>
<td align="left">Chain</td>
<td align="right">9</td>
<td align="right">2</td>
<td align="right">11</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">CapeCod</td>
<td align="left">CapeCod</td>
<td align="right">19</td>
<td align="right">2</td>
<td align="right">21</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Berquist</td>
<td align="left">Berquist</td>
<td align="right">11</td>
<td align="right">2</td>
<td align="right">13</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Hoerl</td>
<td align="left">Hoerl</td>
<td align="right">5</td>
<td align="right">2</td>
<td align="right">7</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Wright</td>
<td align="left">Wright</td>
<td align="right">13</td>
<td align="right">2</td>
<td align="right">15</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="negative-log-likelihood-comparison">Negative Log-Likelihood Comparison<a class="anchor" aria-label="anchor" href="#negative-log-likelihood-comparison"></a>
</h3>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Model <span class="op">=</span> <span class="va">model_names</span>,</span>
<span>  NegLogLik <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">objective</span><span class="op">)</span>,</span>
<span>  AIC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">x</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">objective</span></span>
<span>  <span class="op">}</span><span class="op">)</span>,</span>
<span>  BIC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">A0</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">upper_triangle_mask</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">npar</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">x</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">objective</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">nll_df</span> <span class="op">&lt;-</span> <span class="va">nll_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">nll_df</span><span class="op">$</span><span class="va">AIC</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">nll_df</span>, digits <span class="op">=</span> <span class="fl">2</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Model Fit Statistics (sorted by AIC)"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Model Fit Statistics (sorted by AIC)</caption>
<thead><tr class="header">
<th align="left">Model</th>
<th align="right">NegLogLik</th>
<th align="right">AIC</th>
<th align="right">BIC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Chain</td>
<td align="right">288.69</td>
<td align="right">599.37</td>
<td align="right">621.45</td>
</tr>
<tr class="even">
<td align="left">Wright</td>
<td align="right">291.16</td>
<td align="right">612.33</td>
<td align="right">642.44</td>
</tr>
<tr class="odd">
<td align="left">CapeCod</td>
<td align="right">288.66</td>
<td align="right">619.32</td>
<td align="right">661.47</td>
</tr>
<tr class="even">
<td align="left">Hoerl</td>
<td align="right">312.86</td>
<td align="right">639.71</td>
<td align="right">653.76</td>
</tr>
<tr class="odd">
<td align="left">Berquist</td>
<td align="right">308.72</td>
<td align="right">643.45</td>
<td align="right">669.54</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="diagnostic-plots">Diagnostic Plots<a class="anchor" aria-label="anchor" href="#diagnostic-plots"></a>
</h2>
<div class="section level3">
<h3 id="residual-analysis">Residual Analysis<a class="anchor" aria-label="anchor" href="#residual-analysis"></a>
</h3>
<p>Standardized residuals should be approximately standard normal if the
model fits well.</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="va">model_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">stres</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">stres</span></span>
<span></span>
<span>  <span class="co"># Q-Q plot</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">model_name</span>, <span class="st">"- Q-Q Plot"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqline</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combined residual comparison</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="comprehensive_tutorial_files/figure-html/residual-plots-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="residuals-by-calendar-year">Residuals by Calendar Year<a class="anchor" aria-label="anchor" href="#residuals-by-calendar-year"></a>
</h3>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="va">model_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">stres</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">stres</span></span>
<span>  <span class="va">cy</span> <span class="op">&lt;-</span> <span class="va">rowNum</span> <span class="op">+</span> <span class="va">colNum</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cy</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span>,</span>
<span>       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">model_name</span>, <span class="st">"- by Calendar Year"</span><span class="op">)</span>,</span>
<span>       xlab <span class="op">=</span> <span class="st">"Calendar Year"</span>, ylab <span class="op">=</span> <span class="st">"Std Residual"</span>,</span>
<span>       pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add mean by CY</span></span>
<span>  <span class="va">cy_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cy</span><span class="op">)</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cy_means</span><span class="op">)</span><span class="op">)</span>, <span class="va">cy_means</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="comprehensive_tutorial_files/figure-html/residual-by-cy-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="residuals-by-development-lag">Residuals by Development Lag<a class="anchor" aria-label="anchor" href="#residuals-by-development-lag"></a>
</h3>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="va">model_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">stres</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">stres</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">colNum</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stres</span><span class="op">)</span>,</span>
<span>       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">model_name</span>, <span class="st">"- by Lag"</span><span class="op">)</span>,</span>
<span>       xlab <span class="op">=</span> <span class="st">"Development Lag"</span>, ylab <span class="op">=</span> <span class="st">"Std Residual"</span>,</span>
<span>       pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add mean by lag</span></span>
<span>  <span class="va">lag_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">stres</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span>, <span class="va">lag_means</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="comprehensive_tutorial_files/figure-html/residual-by-lag-1.png" class="r-plt" alt="" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="monte-carlo-simulation">Monte Carlo Simulation<a class="anchor" aria-label="anchor" href="#monte-carlo-simulation"></a>
</h2>
<p>We run simulations to generate full reserve distributions for each
model.</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">nsim</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span></span>
<span><span class="va">sim_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="va">model_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Running simulation for"</span>, <span class="va">model_name</span>, <span class="st">"...\n"</span><span class="op">)</span></span>
<span>  <span class="va">sim_results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span></span>
<span>    <span class="va">results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span>, <span class="va">dnom</span>, <span class="va">upper_triangle_mask</span>, <span class="va">nsim</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Running simulation for Chain ...</span></span>
<span><span class="co">## Running simulation for CapeCod ...</span></span>
<span><span class="co">## Running simulation for Berquist ...</span></span>
<span><span class="co">## Running simulation for Hoerl ...</span></span>
<span><span class="co">## Running simulation for Wright ...</span></span></code></pre>
<div class="section level3">
<h3 id="distribution-of-total-reserves">Distribution of Total Reserves<a class="anchor" aria-label="anchor" href="#distribution-of-total-reserves"></a>
</h3>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="va">model_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sim_results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="st">"Total"</span><span class="op">]</span>, breaks <span class="op">=</span> <span class="fl">50</span>, main <span class="op">=</span> <span class="va">model_name</span>,</span>
<span>         xlab <span class="op">=</span> <span class="st">"Total Reserve"</span>, col <span class="op">=</span> <span class="st">"lightblue"</span>, border <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="st">"Total"</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="st">"Total"</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           col <span class="op">=</span> <span class="st">"blue"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="comprehensive_tutorial_files/figure-html/sim-distributions-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="summary-statistics-from-simulation">Summary Statistics from Simulation<a class="anchor" aria-label="anchor" href="#summary-statistics-from-simulation"></a>
</h3>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  SD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  CV <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Q50 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="va">model_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sim_results</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">total</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">[</span>, <span class="st">"Total"</span><span class="op">]</span></span>
<span>    <span class="va">sim_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sim_summary</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      Model <span class="op">=</span> <span class="va">model_name</span>,</span>
<span>      Mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span>,</span>
<span>      SD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span>,</span>
<span>      CV <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span>,</span>
<span>      Q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">total</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>      Q50 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">total</span>, <span class="fl">0.50</span><span class="op">)</span>,</span>
<span>      Q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">total</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">sim_summary</span>, digits <span class="op">=</span> <span class="fl">0</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Simulation Summary: Total Reserves"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Simulation Summary: Total Reserves</caption>
<thead><tr class="header">
<th align="left">Model</th>
<th align="right">Mean</th>
<th align="right">SD</th>
<th align="right">CV</th>
<th align="right">Q05</th>
<th align="right">Q50</th>
<th align="right">Q95</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Chain</td>
<td align="right">392960259</td>
<td align="right">15561431</td>
<td align="right">0</td>
<td align="right">367489169</td>
<td align="right">393100561</td>
<td align="right">418358515</td>
</tr>
<tr class="even">
<td align="left">CapeCod</td>
<td align="right">391119137</td>
<td align="right">20615514</td>
<td align="right">0</td>
<td align="right">357047772</td>
<td align="right">391091786</td>
<td align="right">425096127</td>
</tr>
<tr class="odd">
<td align="left">Berquist</td>
<td align="right">479838891</td>
<td align="right">29994456</td>
<td align="right">0</td>
<td align="right">431725703</td>
<td align="right">479707042</td>
<td align="right">530528847</td>
</tr>
<tr class="even">
<td align="left">Hoerl</td>
<td align="right">473934097</td>
<td align="right">30221127</td>
<td align="right">0</td>
<td align="right">423963049</td>
<td align="right">473631653</td>
<td align="right">523886441</td>
</tr>
<tr class="odd">
<td align="left">Wright</td>
<td align="right">388494953</td>
<td align="right">20479152</td>
<td align="right">0</td>
<td align="right">355231550</td>
<td align="right">388167747</td>
<td align="right">422943246</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="application-to-simulated-data">Application to Simulated Data<a class="anchor" aria-label="anchor" href="#application-to-simulated-data"></a>
</h2>
<p>We now apply all models to the simulated auto liability data to
demonstrate robustness across different data characteristics.</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare simulated data</span></span>
<span><span class="va">size_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">B0_sim</span><span class="op">)</span></span>
<span><span class="va">logd_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">dnom_sim</span>, <span class="va">size_sim</span>, <span class="va">size_sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rowNum_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.html" class="external-link">row</a></span><span class="op">(</span><span class="va">A0_sim</span><span class="op">)</span></span>
<span><span class="va">colNum_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/col.html" class="external-link">col</a></span><span class="op">(</span><span class="va">A0_sim</span><span class="op">)</span></span>
<span><span class="va">upper_triangle_mask_sim</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">size_sim</span> <span class="op">-</span> <span class="va">rowNum_sim</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">colNum_sim</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">msd_sim</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">size_sim</span> <span class="op">-</span> <span class="va">rowNum_sim</span><span class="op">)</span> <span class="op">==</span> <span class="va">colNum_sim</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">paid_to_date_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">B0_sim</span> <span class="op">*</span> <span class="va">msd_sim</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="va">model_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Fitting"</span>, <span class="va">model_name</span>, <span class="st">"to simulated data...\n"</span><span class="op">)</span></span>
<span>  <span class="va">results_sim</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">fit_model</span><span class="op">(</span></span>
<span>    <span class="va">model_name</span>, <span class="va">B0_sim</span>, <span class="va">A0_sim</span>, <span class="va">dnom_sim</span>, <span class="va">paid_to_date_sim</span>,</span>
<span>    <span class="va">upper_triangle_mask_sim</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Fitting Chain to simulated data...</span></span></code></pre>
<pre><code><span><span class="co">## Fitting CapeCod to simulated data...</span></span></code></pre>
<pre><code><span><span class="co">## Fitting Berquist to simulated data...</span></span>
<span><span class="co">## Fitting Hoerl to simulated data...</span></span>
<span><span class="co">## Fitting Wright to simulated data...</span></span></code></pre>
<div class="section level3">
<h3 id="comparison-on-simulated-data">Comparison on Simulated Data<a class="anchor" aria-label="anchor" href="#comparison-on-simulated-data"></a>
</h3>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comparison_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Model <span class="op">=</span> <span class="va">model_names</span>,</span>
<span>  Reserve <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results_sim</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">calculate_reserves</span><span class="op">(</span><span class="va">x</span>, <span class="va">dnom_sim</span>, <span class="va">upper_triangle_mask_sim</span><span class="op">)</span></span>
<span>    <span class="va">res</span><span class="op">$</span><span class="va">reserve_mean</span><span class="op">[</span><span class="va">size_sim</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span><span class="op">)</span>,</span>
<span>  True_IBNR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">$</span><span class="va">ultimates</span> <span class="op">*</span> <span class="va">dnom_sim</span><span class="op">)</span> <span class="op">-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">B0_sim</span> <span class="op">*</span> <span class="va">upper_triangle_mask_sim</span> <span class="op">*</span> <span class="va">dnom_sim</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">comparison_sim</span><span class="op">$</span><span class="va">Error_Pct</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">comparison_sim</span><span class="op">$</span><span class="va">Reserve</span> <span class="op">-</span></span>
<span>  <span class="va">comparison_sim</span><span class="op">$</span><span class="va">True_IBNR</span><span class="op">)</span> <span class="op">/</span> <span class="va">comparison_sim</span><span class="op">$</span><span class="va">True_IBNR</span> <span class="op">*</span> <span class="fl">100</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">comparison_sim</span>, digits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Reserve Estimates vs True IBNR (Simulated Data)"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Reserve Estimates vs True IBNR (Simulated Data)</caption>
<thead><tr class="header">
<th align="left">Model</th>
<th align="right">Reserve</th>
<th align="right">True_IBNR</th>
<th align="right">Error_Pct</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Chain</td>
<td align="right">466237577</td>
<td align="right">-7763805521</td>
<td align="right">-106.0</td>
</tr>
<tr class="even">
<td align="left">CapeCod</td>
<td align="right">458610010</td>
<td align="right">-7763805521</td>
<td align="right">-105.9</td>
</tr>
<tr class="odd">
<td align="left">Berquist</td>
<td align="right">456073545</td>
<td align="right">-7763805521</td>
<td align="right">-105.9</td>
</tr>
<tr class="even">
<td align="left">Hoerl</td>
<td align="right">458513352</td>
<td align="right">-7763805521</td>
<td align="right">-105.9</td>
</tr>
<tr class="odd">
<td align="left">Wright</td>
<td align="right">464082728</td>
<td align="right">-7763805521</td>
<td align="right">-106.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="model-selection-guidance">Model Selection Guidance<a class="anchor" aria-label="anchor" href="#model-selection-guidance"></a>
</h2>
<p>Based on the analysis above, here is guidance for model
selection:</p>
<div class="section level3">
<h3 id="when-to-use-each-model">When to Use Each Model<a class="anchor" aria-label="anchor" href="#when-to-use-each-model"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p><strong>Chain Ladder</strong>: Best for stable, mature lines with
consistent development. Fewest parameters (9) provides robustness but
less flexibility.</p></li>
<li><p><strong>Cape Cod</strong>: Preferred when you have reliable prior
information about ultimate severity levels. The separate row and column
factors (19 parameters) provide flexibility but require more data to
estimate reliably.</p></li>
<li><p><strong>Berquist-Sherman</strong>: Use when you suspect
systematic changes in development patterns over time. The explicit trend
parameter (11 total) helps identify and quantify development year
trends.</p></li>
<li><p><strong>Hoerl Curve</strong>: Good for smooth development
patterns. With only 5 model parameters, it‚Äôs parsimonious while still
capturing key features. The mathematical form ensures sensible
extrapolation.</p></li>
<li><p><strong>Wright</strong>: Most flexible individual year treatment
(13 parameters). Use when accident years have genuinely different
characteristics that shouldn‚Äôt be constrained to a linear
trend.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="model-uncertainty">Model Uncertainty<a class="anchor" aria-label="anchor" href="#model-uncertainty"></a>
</h3>
<p>As Hayne emphasizes, practitioners should ‚Äúuse multiple methods‚Äù
because divergent forecasts indicate where underlying assumptions
require investigation. The differences between models reflect
<strong>model uncertainty</strong> - a key component of total reserve
uncertainty often underappreciated in practice.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This tutorial demonstrated all five stochastic reserving models in
the <code>stochasticreserver</code> package:</p>
<ul>
<li>
<strong>Chain Ladder</strong>: Simplest, most constrained</li>
<li>
<strong>Cape Cod</strong>: Exposure-based with separate factors</li>
<li>
<strong>Berquist-Sherman</strong>: Explicit development trend</li>
<li>
<strong>Hoerl</strong>: Smooth parametric curve</li>
<li>
<strong>Wright</strong>: Individual year levels</li>
</ul>
<p>The unified maximum likelihood framework enables: 1. Consistent
parameter estimation across models 2. Proper uncertainty quantification
3. Model comparison via information criteria 4. Monte Carlo simulation
for reserve distributions</p>
<p>For production use, consider: - Running multiple models and comparing
results - Examining residual diagnostics carefully - Using simulation to
capture parameter uncertainty - Recognizing that model differences
indicate structural uncertainty</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Hayne, R. ‚ÄúA Flexible Framework for Stochastic Reserving Models.‚Äù
<em>Variance</em>, Vol 7, Issue 2. Available at: <a href="https://variancejournal.org/article/120823" class="external-link uri">https://variancejournal.org/article/120823</a></p>
</div>
<div class="section level2">
<h2 id="session-information">Session Information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.5.2 (2025-10-31)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">##  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">## [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] abind_1.4-8              mvtnorm_1.3-3            stochasticreserver_0.1.1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] digest_0.6.39     desc_1.4.3        R6_2.6.1          fastmap_1.2.0    </span></span>
<span><span class="co">##  [5] xfun_0.56         cachem_1.1.0      knitr_1.51        htmltools_0.5.9  </span></span>
<span><span class="co">##  [9] rmarkdown_2.30    lifecycle_1.0.5   cli_3.6.5         sass_0.4.10      </span></span>
<span><span class="co">## [13] pkgdown_2.2.0     textshaping_1.0.4 jquerylib_0.1.4   systemfonts_1.3.1</span></span>
<span><span class="co">## [17] compiler_4.5.2    tools_4.5.2       ragg_1.5.0        evaluate_1.0.5   </span></span>
<span><span class="co">## [21] bslib_0.9.0       yaml_2.3.12       jsonlite_2.0.0    rlang_1.1.7      </span></span>
<span><span class="co">## [25] fs_1.6.6</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Roger Hayne, R. Mark Sharp.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>



  <script>
document.addEventListener('DOMContentLoaded', function() {
  var codeBlocks = document.querySelectorAll('div.sourceCode');
  codeBlocks.forEach(function(block) {
    var btn = document.createElement('button');
    btn.className = 'code-fold-btn';
    btn.innerHTML = '&#9654; Show Code';
    btn.onclick = function() {
      if (block.classList.contains('hidden')) {
        block.classList.remove('hidden');
        btn.innerHTML = '&#9660; Hide Code';
      } else {
        block.classList.add('hidden');
        btn.innerHTML = '&#9654; Show Code';
      }
    };
    block.classList.add('hidden');
    block.parentNode.insertBefore(btn, block);
  });
});
</script>
</body>
</html>
